# ==============================================================================
# CRYPTO INSPECT - CUSTOM LOVELACE CARDS
# ==============================================================================
# Copy these cards to your Lovelace dashboard configuration
# Requires: custom:apexcharts-card, custom:mushroom-template-card
# ==============================================================================

# ------------------------------------------------------------------------------
# FEAR & GREED GAUGE
# ------------------------------------------------------------------------------
# Beautiful radial gauge for Fear & Greed Index
# Install: HACS -> Frontend -> ApexCharts Card

fear_greed_gauge:
  type: custom:apexcharts-card
  chart_type: radialBar
  header:
    show: true
    title: Fear & Greed Index
    show_states: true
    colorize_states: true
  series:
    - entity: sensor.crypto_inspect_fear_greed
      name: F&G
      color_threshold:
        - value: 0
          color: '#dc3545'
        - value: 25
          color: '#fd7e14'
        - value: 45
          color: '#ffc107'
        - value: 55
          color: '#20c997'
        - value: 75
          color: '#28a745'
  apex_config:
    plotOptions:
      radialBar:
        startAngle: -135
        endAngle: 135
        hollow:
          size: '60%'
        dataLabels:
          name:
            show: true
            fontSize: '14px'
          value:
            fontSize: '36px'
            fontWeight: bold
    labels:
      - Fear & Greed

# ------------------------------------------------------------------------------
# RSI INDICATOR CARD
# ------------------------------------------------------------------------------
# RSI with overbought/oversold zones using template for dictionary sensor

rsi_indicator:
  type: custom:mushroom-template-card
  primary: "RSI Values"
  secondary: |
    {% set data = states('sensor.crypto_inspect_ta_rsi') | from_json %}
    BTC: {{ data.BTC | default('N/A') }} | ETH: {{ data.ETH | default('N/A') }}
  icon: mdi:chart-line
  icon_color: |
    {% set data = states('sensor.crypto_inspect_ta_rsi') | from_json %}
    {% set rsi = data.BTC | default(50) | float %}
    {% if rsi < 30 %}green{% elif rsi > 70 %}red{% else %}orange{% endif %}

# ------------------------------------------------------------------------------
# TECHNICAL ANALYSIS SUMMARY
# ------------------------------------------------------------------------------
# Using template cards for dictionary-based sensors

technical_summary:
  type: vertical-stack
  title: "ðŸ“Š Technical Analysis"
  cards:
    - type: custom:mushroom-template-card
      primary: "RSI"
      secondary: |
        {% set data = states('sensor.crypto_inspect_ta_rsi') | from_json %}
        BTC: {{ data.BTC | default('N/A') }} | ETH: {{ data.ETH | default('N/A') }}
      icon: mdi:chart-line

    - type: custom:mushroom-template-card
      primary: "MACD Signal"
      secondary: |
        {% set data = states('sensor.crypto_inspect_ta_macd_signal') | from_json %}
        BTC: {{ data.BTC | default('N/A') }} | ETH: {{ data.ETH | default('N/A') }}
      icon: mdi:signal

    - type: custom:mushroom-template-card
      primary: "Trend"
      secondary: |
        {% set data = states('sensor.crypto_inspect_ta_trend') | from_json %}
        BTC: {{ data.BTC | default('N/A') }} | ETH: {{ data.ETH | default('N/A') }}
      icon: mdi:trending-up

    - type: entities
      entities:
        - entity: sensor.crypto_inspect_ta_confluence
          name: Confluence Score
          icon: mdi:check-all
        - entity: sensor.crypto_inspect_ta_signal
          name: TA Signal
          icon: mdi:traffic-light

    - type: custom:mushroom-template-card
      primary: "Support / Resistance"
      secondary: |
        {% set support = states('sensor.crypto_inspect_ta_support') | from_json %}
        {% set resist = states('sensor.crypto_inspect_ta_resistance') | from_json %}
        S: ${{ '{:,.0f}'.format(support.BTC | default(0)) }} | R: ${{ '{:,.0f}'.format(resist.BTC | default(0)) }}
      icon: mdi:arrow-expand-vertical

# ------------------------------------------------------------------------------
# RISK DASHBOARD
# ------------------------------------------------------------------------------

risk_dashboard:
  type: vertical-stack
  cards:
    - type: custom:mushroom-template-card
      primary: "Risk Status"
      secondary: "{{ states('sensor.crypto_inspect_risk_status') }}"
      icon: mdi:shield-alert
      icon_color: |
        {% set status = states('sensor.crypto_inspect_risk_status') %}
        {% if status == 'Low' %}green
        {% elif status == 'Medium' %}orange
        {% elif status == 'High' %}red
        {% else %}purple{% endif %}

    - type: glance
      title: Risk Metrics
      entities:
        - entity: sensor.crypto_inspect_portfolio_sharpe
          name: Sharpe
        - entity: sensor.crypto_inspect_portfolio_max_drawdown
          name: Max DD
        - entity: sensor.crypto_inspect_portfolio_var_95
          name: VaR 95%
        - entity: sensor.crypto_inspect_portfolio_current_drawdown
          name: Current DD

# ------------------------------------------------------------------------------
# AI INSIGHTS CARD
# ------------------------------------------------------------------------------

ai_insights:
  type: vertical-stack
  cards:
    - type: custom:mushroom-template-card
      primary: "ðŸ¤– AI Analysis"
      secondary: "{{ states('sensor.crypto_inspect_ai_market_sentiment') }}"
      icon: mdi:robot
      icon_color: |
        {% set sentiment = states('sensor.crypto_inspect_ai_market_sentiment') %}
        {% if sentiment == 'Bullish' %}green
        {% elif sentiment == 'Bearish' %}red
        {% else %}blue{% endif %}

    - type: markdown
      content: |
        **ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·:** {{ states('sensor.crypto_inspect_ai_last_analysis') }}

        {{ states('sensor.crypto_inspect_ai_daily_summary') }}

        **Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ:** {{ states('sensor.crypto_inspect_ai_recommendation') }}

# ------------------------------------------------------------------------------
# DCA PERFORMANCE
# ------------------------------------------------------------------------------

dca_performance:
  type: entities
  title: "ðŸ“ˆ DCA Backtest Results"
  entities:
    - entity: sensor.crypto_inspect_backtest_dca_roi
      name: Fixed DCA ROI
      icon: mdi:percent
    - entity: sensor.crypto_inspect_backtest_smart_dca_roi
      name: Smart DCA ROI
      icon: mdi:brain
    - entity: sensor.crypto_inspect_backtest_lump_sum_roi
      name: Lump Sum ROI
      icon: mdi:cash
    - entity: sensor.crypto_inspect_backtest_best_strategy
      name: Best Strategy
      icon: mdi:trophy

# ------------------------------------------------------------------------------
# MULTI-TIMEFRAME TRENDS
# ------------------------------------------------------------------------------
# Using template card for dictionary sensor

mtf_trends:
  type: custom:mushroom-template-card
  primary: "ðŸ• MTF Trends"
  secondary: |
    {% set data = states('sensor.crypto_inspect_ta_trend_mtf') | from_json %}
    {% set btc = data.BTC | default({}) %}
    1H: {{ btc.get('1h', 'N/A') }} | 4H: {{ btc.get('4h', 'N/A') }} | 1D: {{ btc.get('1d', 'N/A') }}
  icon: mdi:clock-outline
  layout: vertical

# ------------------------------------------------------------------------------
# PORTFOLIO PIE CHART
# ------------------------------------------------------------------------------
# Requires sensor with allocation attribute

portfolio_pie:
  type: custom:apexcharts-card
  chart_type: pie
  header:
    show: true
    title: Portfolio Allocation
  series:
    - entity: sensor.crypto_inspect_bybit_balance
      attribute: allocation
      data_generator: |
        return Object.entries(entity.attributes.allocation || {}).map(([name, value]) => ({
          x: name,
          y: value
        }));
  apex_config:
    legend:
      show: true
      position: bottom
    dataLabels:
      enabled: true
      formatter: |
        EVAL:function(val) { return val.toFixed(1) + '%'; }

# ------------------------------------------------------------------------------
# MINI PRICE CHART
# ------------------------------------------------------------------------------

price_chart_7d:
  type: custom:apexcharts-card
  header:
    show: true
    title: BTC Price (7 days)
  graph_span: 7d
  series:
    - entity: sensor.crypto_inspect_prices
      attribute: BTC/USDT
      name: BTC
      type: line
      stroke_width: 2
      color: '#f7931a'
  apex_config:
    chart:
      height: 200
    stroke:
      curve: smooth
    yaxis:
      labels:
        formatter: |
          EVAL:function(val) { return '$' + val.toLocaleString(); }

# ------------------------------------------------------------------------------
# COMPLETE CRYPTO DASHBOARD
# ------------------------------------------------------------------------------
# Full dashboard combining all cards

complete_dashboard:
  title: Crypto Inspect
  views:
    - title: Overview
      path: overview
      icon: mdi:view-dashboard
      cards:
        - type: horizontal-stack
          cards:
            - type: custom:mushroom-template-card
              primary: BTC
              secondary: "${{ states('sensor.crypto_inspect_prices') | from_json | default({}) | selectattr('key', 'eq', 'BTC/USDT') | map(attribute='value') | first | default('N/A') | round(0) | int }}"
              icon: mdi:bitcoin
              icon_color: orange
            - type: custom:mushroom-template-card
              primary: Fear & Greed
              secondary: "{{ states('sensor.crypto_inspect_fear_greed') }}"
              icon: mdi:emoticon-neutral
              icon_color: |
                {% set val = states('sensor.crypto_inspect_fear_greed') | int(50) %}
                {% if val < 25 %}red{% elif val < 45 %}orange{% elif val < 55 %}yellow{% elif val < 75 %}green{% else %}light-green{% endif %}

        - type: custom:apexcharts-card
          chart_type: radialBar
          series:
            - entity: sensor.crypto_inspect_fear_greed
          apex_config:
            plotOptions:
              radialBar:
                startAngle: -135
                endAngle: 135

        - type: entities
          title: "ðŸ“Š Market Overview"
          entities:
            - entity: sensor.crypto_inspect_btc_dominance
            - entity: sensor.crypto_inspect_altseason_status
            - entity: sensor.crypto_inspect_volatility_status
            - entity: sensor.crypto_inspect_investor_phase

        - type: entities
          title: "ðŸŽ¯ DCA Recommendation"
          entities:
            - entity: sensor.crypto_inspect_dca_zone
            - entity: sensor.crypto_inspect_dca_next_level
            - entity: sensor.crypto_inspect_dca_signal
            - entity: sensor.crypto_inspect_dca_result
