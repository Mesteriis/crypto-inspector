# =============================================================================
# Ð¦Ð•ÐÐžÐ’Ð«Ð• ÐÐ›Ð•Ð Ð¢Ð«
# =============================================================================
# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ñ†ÐµÐ½Ð¾Ð²Ñ‹Ñ… Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ð¹

# -----------------------------------------------------------------------------
# 1. BTC Ð¿Ñ€Ð¾Ð±Ð¸Ð» Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼
# -----------------------------------------------------------------------------
- id: crypto_btc_ath_alert
  alias: "Crypto: BTC Ð¿Ñ€Ð¾Ð±Ð¸Ð» ATH"
  description: "Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð³Ð´Ð° BTC Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼"
  trigger:
    - platform: template
      value_template: >
        {{ states('sensor.crypto_inspect_prices') | from_json | default({}) 
           | selectattr('BTC') | first | default(0) > 
           state_attr('sensor.crypto_inspect_prices', 'btc_ath') | default(100000) }}
  condition:
    - condition: state
      entity_id: input_boolean.crypto_alerts_enabled
      state: "on"
  action:
    - service: notify.mobile_app
      data:
        title: "ðŸš€ BTC ATH!"
        message: "Bitcoin Ð¾Ð±Ð½Ð¾Ð²Ð¸Ð» Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼: ${{ states('sensor.crypto_inspect_prices') | from_json | default({}) | selectattr('BTC') | first | round(0) }}"
        data:
          priority: high
          tag: btc_ath

# -----------------------------------------------------------------------------
# 2. Ð ÐµÐ·ÐºÐ¾Ðµ Ð¿Ð°Ð´ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ½Ñ‹ (Flash Crash)
# -----------------------------------------------------------------------------
- id: crypto_flash_crash_alert
  alias: "Crypto: Flash Crash Ð´ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€"
  description: "Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð¿Ð°Ð´ÐµÐ½Ð¸Ð¸ >5% Ð·Ð° Ñ‡Ð°Ñ"
  trigger:
    - platform: template
      value_template: >
        {% set changes = states('sensor.crypto_inspect_changes_24h') | from_json | default({}) %}
        {{ changes.values() | select('lt', -5) | list | count > 0 }}
  condition:
    - condition: state
      entity_id: input_boolean.crypto_alerts_enabled
      state: "on"
  action:
    - service: notify.mobile_app
      data:
        title: "âš ï¸ Flash Crash!"
        message: >
          {% set changes = states('sensor.crypto_inspect_changes_24h') | from_json | default({}) %}
          Ð ÐµÐ·ÐºÐ¾Ðµ Ð¿Ð°Ð´ÐµÐ½Ð¸Ðµ: {{ changes | dictsort(by='value') | first | first }} {{ changes | dictsort(by='value') | first | last | round(1) }}%
        data:
          priority: critical
          channel: crypto_alerts

# -----------------------------------------------------------------------------
# 3. Ð¦ÐµÐ½Ð° Ð´Ð¾ÑÑ‚Ð¸Ð³Ð»Ð° ÑƒÑ€Ð¾Ð²Ð½Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸
# -----------------------------------------------------------------------------
- id: crypto_support_level_hit
  alias: "Crypto: Ð¦ÐµÐ½Ð° Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸"
  description: "Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð³Ð´Ð° Ñ†ÐµÐ½Ð° ÐºÐ°ÑÐ°ÐµÑ‚ÑÑ ÐºÐ»ÑŽÑ‡ÐµÐ²Ð¾Ð³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸"
  trigger:
    - platform: state
      entity_id: sensor.crypto_inspect_ta_support
  condition:
    - condition: template
      value_template: >
        {{ trigger.to_state.state != trigger.from_state.state and 
           'near_support' in trigger.to_state.attributes.get('status', '') }}
  action:
    - service: notify.mobile_app
      data:
        title: "ðŸ“‰ Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸"
        message: "Ð¦ÐµÐ½Ð° Ð±Ð»Ð¸Ð·ÐºÐ° Ðº Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐµ. Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð´Ð»Ñ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸?"

# -----------------------------------------------------------------------------
# 4. Ð¦ÐµÐ½Ð° Ð´Ð¾ÑÑ‚Ð¸Ð³Ð»Ð° ÑƒÑ€Ð¾Ð²Ð½Ñ ÑÐ¾Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð»ÐµÐ½Ð¸Ñ
# -----------------------------------------------------------------------------
- id: crypto_resistance_level_hit
  alias: "Crypto: Ð¦ÐµÐ½Ð° Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ ÑÐ¾Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð»ÐµÐ½Ð¸Ñ"
  description: "Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð³Ð´Ð° Ñ†ÐµÐ½Ð° ÐºÐ°ÑÐ°ÐµÑ‚ÑÑ ÐºÐ»ÑŽÑ‡ÐµÐ²Ð¾Ð³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ ÑÐ¾Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð»ÐµÐ½Ð¸Ñ"
  trigger:
    - platform: state
      entity_id: sensor.crypto_inspect_ta_resistance
  condition:
    - condition: template
      value_template: >
        {{ trigger.to_state.state != trigger.from_state.state and 
           'near_resistance' in trigger.to_state.attributes.get('status', '') }}
  action:
    - service: notify.mobile_app
      data:
        title: "ðŸ“ˆ Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ ÑÐ¾Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð»ÐµÐ½Ð¸Ñ"
        message: "Ð¦ÐµÐ½Ð° Ð±Ð»Ð¸Ð·ÐºÐ° Ðº ÑÐ¾Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð»ÐµÐ½Ð¸ÑŽ. Ð¤Ð¸ÐºÑÐ°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸Ð±Ñ‹Ð»Ð¸?"

# -----------------------------------------------------------------------------
# 5. Ð—Ð½Ð°Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð° 24Ñ‡ (>10%)
# -----------------------------------------------------------------------------
- id: crypto_significant_move
  alias: "Crypto: Ð—Ð½Ð°Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ðµ >10%"
  description: "Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ð¸ Ð±Ð¾Ð»ÐµÐµ 10% Ð·Ð° ÑÑƒÑ‚ÐºÐ¸"
  trigger:
    - platform: template
      value_template: >
        {% set changes = states('sensor.crypto_inspect_changes_24h') | from_json | default({}) %}
        {{ changes.values() | map('abs') | select('gt', 10) | list | count > 0 }}
  condition:
    - condition: state
      entity_id: input_boolean.crypto_alerts_enabled
      state: "on"
  action:
    - service: notify.mobile_app
      data:
        title: "ðŸ“Š Ð¡Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ðµ"
        message: >
          {% set changes = states('sensor.crypto_inspect_changes_24h') | from_json | default({}) %}
          {% for coin, change in changes.items() if change | abs > 10 %}
          {{ coin }}: {{ '+' if change > 0 else '' }}{{ change | round(1) }}%
          {% endfor %}

# -----------------------------------------------------------------------------
# 6. ÐÐ¾Ð²Ñ‹Ð¹ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ (7 Ð´Ð½ÐµÐ¹)
# -----------------------------------------------------------------------------
- id: crypto_local_low
  alias: "Crypto: ÐÐ¾Ð²Ñ‹Ð¹ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼"
  description: "Ð¦ÐµÐ½Ð° Ð´Ð¾ÑÑ‚Ð¸Ð³Ð»Ð° Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼Ð° Ð·Ð° 7 Ð´Ð½ÐµÐ¹ - Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð´Ð»Ñ DCA"
  trigger:
    - platform: template
      value_template: >
        {% set lows = states('sensor.crypto_inspect_lows_24h') | from_json | default({}) %}
        {% set prices = states('sensor.crypto_inspect_prices') | from_json | default({}) %}
        {{ prices.get('BTC', 0) <= lows.get('BTC', 999999) * 1.01 }}
  action:
    - service: notify.mobile_app
      data:
        title: "ðŸ’° Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼"
        message: "BTC Ð½Ð° Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼Ðµ. Ð¥Ð¾Ñ€Ð¾ÑˆÐ¸Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚ Ð´Ð»Ñ DCA?"
