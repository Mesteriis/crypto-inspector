# =============================================================================
# Evening Briefing Blueprint
# =============================================================================
# Sends a day-end summary with performance and tomorrow's preview
#
# Usage: Import into Home Assistant blueprints and configure notification service
# =============================================================================

blueprint:
  name: "Crypto Evening Briefing / Ğ’ĞµÑ‡ĞµÑ€Ğ½Ğ¸Ğ¹ Ğ±Ñ€Ğ¸Ñ„Ğ¸Ğ½Ğ³"
  description: >-
    Send an evening summary with day's performance and tomorrow's preview.
    ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ²ĞµÑ‡ĞµÑ€Ğ½ÑÑ ÑĞ²Ğ¾Ğ´ĞºÑƒ Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°Ğ¼Ğ¸ Ğ´Ğ½Ñ Ğ¸ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ¾Ğ¼ Ğ½Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°.
  domain: automation
  author: "Crypto Inspect Add-on"
  source_url: "https://github.com/Mesteriis/crypto-inspector"

  input:
    notify_device:
      name: "Notification Service / Ğ¡ĞµÑ€Ğ²Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹"
      description: >-
        The notification service to use.
        Ğ¡ĞµÑ€Ğ²Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸.
      selector:
        text:
      default: "notify.mobile_app"

    send_time:
      name: "Send Time / Ğ’Ñ€ĞµĞ¼Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸"
      description: >-
        Time to send the evening briefing.
        Ğ’Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ²ĞµÑ‡ĞµÑ€Ğ½ĞµĞ³Ğ¾ Ğ±Ñ€Ğ¸Ñ„Ğ¸Ğ½Ğ³Ğ°.
      selector:
        time:
      default: "21:00:00"

    language:
      name: "Language / Ğ¯Ğ·Ñ‹Ğº"
      description: >-
        Notification language.
        Ğ¯Ğ·Ñ‹Ğº ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹.
      selector:
        select:
          options:
            - label: "English"
              value: "en"
            - label: "Ğ ÑƒÑÑĞºĞ¸Ğ¹"
              value: "ru"
      default: "ru"

    include_weekly_friday:
      name: "Include Weekly Summary on Friday / Ğ’ĞºĞ»ÑÑ‡Ğ°Ñ‚ÑŒ Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½ÑƒÑ ÑĞ²Ğ¾Ğ´ĞºÑƒ Ğ¿Ğ¾ Ğ¿ÑÑ‚Ğ½Ğ¸Ñ†Ğ°Ğ¼"
      description: >-
        Add weekly summary section on Fridays.
        Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½ÑƒÑ ÑĞ²Ğ¾Ğ´ĞºÑƒ Ğ¿Ğ¾ Ğ¿ÑÑ‚Ğ½Ğ¸Ñ†Ğ°Ğ¼.
      selector:
        boolean:
      default: true

trigger:
  - platform: time
    at: !input send_time

condition: []

action:
  - variables:
      lang: !input language
      include_weekly: !input include_weekly_friday
      is_friday: "{{ now().weekday() == 4 }}"
      btc_price: "{{ states('sensor.crypto_inspect_prices') }}"
      btc_change: "{{ state_attr('sensor.crypto_inspect_changes_24h', 'BTC/USDT') | default('N/A') }}"
      portfolio_pnl: "{{ states('sensor.crypto_inspect_portfolio_pnl_24h') | default('N/A') }}"
      alerts_count: "{{ states.sensor | selectattr('entity_id', 'match', 'sensor\\.crypto_inspect_.*alert.*') | list | count }}"
      risk_status: "{{ states('sensor.crypto_inspect_market_tension') }}"

  - choose:
      # Russian
      - conditions:
          - condition: template
            value_template: "{{ lang == 'ru' }}"
        sequence:
          - service: !input notify_device
            data:
              title: "ğŸŒ™ Ğ”Ğ¾Ğ±Ñ€Ñ‹Ğ¹ Ğ²ĞµÑ‡ĞµÑ€! Ğ”Ğ½ĞµĞ²Ğ½Ğ°Ñ ÑĞ²Ğ¾Ğ´ĞºĞ°"
              message: >-
                ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ´Ğ½Ñ:
                BTC: ${{ btc_price }} ({{ btc_change }}%)
                ĞŸĞ¾Ñ€Ñ‚Ñ„ĞµĞ»ÑŒ: {{ portfolio_pnl }}%

                âš ï¸ Ğ Ğ¸ÑĞº: {{ risk_status }}
                ğŸ”” ĞĞ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ğ¹: {{ alerts_count }}

                {% if include_weekly and is_friday %}
                ğŸ“… ĞĞµĞ´ĞµĞ»ÑŒĞ½Ğ°Ñ ÑĞ²Ğ¾Ğ´ĞºĞ°:
                {{ states('sensor.crypto_inspect_weekly_insight') }}
                {% endif %}

                Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞµĞ³Ğ¾ Ğ²ĞµÑ‡ĞµÑ€Ğ°! ğŸŒŸ
              data:
                group: "crypto-briefing"
                tag: "evening-briefing"
                importance: default

      # English (default)
      - conditions:
          - condition: template
            value_template: "{{ lang == 'en' }}"
        sequence:
          - service: !input notify_device
            data:
              title: "ğŸŒ™ Good Evening! Daily Summary"
              message: >-
                ğŸ“Š Day's Results:
                BTC: ${{ btc_price }} ({{ btc_change }}%)
                Portfolio: {{ portfolio_pnl }}%

                âš ï¸ Risk: {{ risk_status }}
                ğŸ”” Alerts: {{ alerts_count }}

                {% if include_weekly and is_friday %}
                ğŸ“… Weekly Summary:
                {{ states('sensor.crypto_inspect_weekly_insight') }}
                {% endif %}

                Have a great evening! ğŸŒŸ
              data:
                group: "crypto-briefing"
                tag: "evening-briefing"
                importance: default

mode: single
