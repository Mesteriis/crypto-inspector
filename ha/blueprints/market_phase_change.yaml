# =============================================================================
# Market Phase Change Alert Blueprint / ĞĞ»ĞµÑ€Ñ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ·Ñ‹ Ñ€Ñ‹Ğ½ĞºĞ°
# =============================================================================
# Sends notification when market phase changes
# ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ ÑĞ¼ĞµĞ½Ğµ Ñ„Ğ°Ğ·Ñ‹ Ñ€Ñ‹Ğ½ĞºĞ°
# =============================================================================

blueprint:
  name: "Market Phase Change / Ğ¡Ğ¼ĞµĞ½Ğ° Ñ„Ğ°Ğ·Ñ‹ Ñ€Ñ‹Ğ½ĞºĞ°"
  description: >-
    Get notified when the market phase changes (Accumulation, Growth, Euphoria, etc.).
    Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ ÑĞ¼ĞµĞ½Ğµ Ñ„Ğ°Ğ·Ñ‹ Ñ€Ñ‹Ğ½ĞºĞ° (ĞĞ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ğµ, Ğ Ğ¾ÑÑ‚, Ğ­Ğ¹Ñ„Ğ¾Ñ€Ğ¸Ñ Ğ¸ Ñ‚.Ğ´.).
  domain: automation
  author: "Crypto Inspect Add-on"
  source_url: "https://github.com/Mesteriis/crypto-inspector"

  input:
    notify_service:
      name: "Notification Service / Ğ¡ĞµÑ€Ğ²Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹"
      description: >-
        The notification service to use.
        Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹.
      selector:
        text:
      default: "notify.mobile_app"

    language:
      name: "Language / Ğ¯Ğ·Ñ‹Ğº"
      description: "Notification language / Ğ¯Ğ·Ñ‹Ğº ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹"
      selector:
        select:
          options:
            - label: "English"
              value: "en"
            - label: "Ğ ÑƒÑÑĞºĞ¸Ğ¹"
              value: "ru"
      default: "ru"

    notify_accumulation:
      name: "Notify on Accumulation / Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ğ¾ Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ğ¸"
      description: "Send alert when entering Accumulation phase"
      selector:
        boolean:
      default: true

    notify_growth:
      name: "Notify on Growth / Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ğ¾ Ñ€Ğ¾ÑÑ‚Ğµ"
      description: "Send alert when entering Growth phase"
      selector:
        boolean:
      default: true

    notify_euphoria:
      name: "Notify on Euphoria / Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ğ¾Ğ± ÑĞ¹Ñ„Ğ¾Ñ€Ğ¸Ğ¸"
      description: "Send alert when entering Euphoria phase"
      selector:
        boolean:
      default: true

    notify_correction:
      name: "Notify on Correction / Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ğ¾ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ†Ğ¸Ğ¸"
      description: "Send alert when entering Correction phase"
      selector:
        boolean:
      default: true

    notify_capitulation:
      name: "Notify on Capitulation / Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ğ¾ ĞºĞ°Ğ¿Ğ¸Ñ‚ÑƒĞ»ÑÑ†Ğ¸Ğ¸"
      description: "Send alert when entering Capitulation phase"
      selector:
        boolean:
      default: true

trigger:
  - platform: state
    entity_id: sensor.crypto_inspect_investor_phase
    not_from:
      - "unknown"
      - "unavailable"
    not_to:
      - "unknown"
      - "unavailable"

condition:
  - condition: template
    value_template: >
      {% set new_phase = trigger.to_state.state | lower %}
      {% set notify_acc = !input notify_accumulation %}
      {% set notify_growth = !input notify_growth %}
      {% set notify_euph = !input notify_euphoria %}
      {% set notify_corr = !input notify_correction %}
      {% set notify_cap = !input notify_capitulation %}

      {% if 'accumulation' in new_phase and notify_acc %}true
      {% elif 'growth' in new_phase and notify_growth %}true
      {% elif 'euphoria' in new_phase and notify_euph %}true
      {% elif 'correction' in new_phase and notify_corr %}true
      {% elif 'capitulation' in new_phase and notify_cap %}true
      {% else %}false{% endif %}

action:
  - variables:
      lang: !input language
      old_phase: "{{ trigger.from_state.state }}"
      new_phase: "{{ trigger.to_state.state }}"
      fear_greed: "{{ states('sensor.crypto_inspect_fear_greed') }}"
      dca_signal: "{{ states('sensor.crypto_inspect_dca_signal') }}"
      calm: "{{ states('sensor.crypto_inspect_calm_indicator') }}"

  - choose:
      # Russian
      - conditions:
          - condition: template
            value_template: "{{ lang == 'ru' }}"
        sequence:
          - service: !input notify_service
            data:
              title: >-
                {% set p = new_phase | lower %}
                {% if 'accumulation' in p %}ğŸ“Š Ğ¤Ğ°Ğ·Ğ°: ĞĞ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ğµ
                {% elif 'growth' in p %}ğŸ“ˆ Ğ¤Ğ°Ğ·Ğ°: Ğ Ğ¾ÑÑ‚
                {% elif 'euphoria' in p %}ğŸš€ Ğ¤Ğ°Ğ·Ğ°: Ğ­Ğ¹Ñ„Ğ¾Ñ€Ğ¸Ñ
                {% elif 'correction' in p %}ğŸ“‰ Ğ¤Ğ°Ğ·Ğ°: ĞšĞ¾Ñ€Ñ€ĞµĞºÑ†Ğ¸Ñ
                {% elif 'capitulation' in p %}ğŸ’¥ Ğ¤Ğ°Ğ·Ğ°: ĞšĞ°Ğ¿Ğ¸Ñ‚ÑƒĞ»ÑÑ†Ğ¸Ñ
                {% else %}ğŸ“Š Ğ¡Ğ¼ĞµĞ½Ğ° Ñ„Ğ°Ğ·Ñ‹ Ñ€Ñ‹Ğ½ĞºĞ°{% endif %}
              message: >-
                {{ old_phase }} â†’ {{ new_phase }}

                {% set p = new_phase | lower %}
                {% if 'accumulation' in p %}
                ğŸ’¡ Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹
                {% elif 'growth' in p %}
                ğŸ“ˆ Ğ Ñ‹Ğ½Ğ¾Ğº Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚, ÑƒĞ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸
                {% elif 'euphoria' in p %}
                âš ï¸ Ğ Ñ‹Ğ½Ğ¾Ğº Ğ¿ĞµÑ€ĞµĞ³Ñ€ĞµÑ‚, Ğ±ÑƒĞ´ÑŒÑ‚Ğµ Ğ¾ÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ‹
                {% elif 'correction' in p %}
                ğŸ“‰ ĞšĞ¾Ñ€Ñ€ĞµĞºÑ†Ğ¸Ñ, Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸
                {% elif 'capitulation' in p %}
                ğŸ’¥ ĞšĞ°Ğ¿Ğ¸Ñ‚ÑƒĞ»ÑÑ†Ğ¸Ñ, ÑĞºÑÑ‚Ñ€ĞµĞ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ‚Ñ€Ğ°Ñ…
                {% endif %}

                Fear & Greed: {{ fear_greed }}
                DCA: {{ dca_signal }}
                Ğ¡Ğ¿Ğ¾ĞºĞ¾Ğ¹ÑÑ‚Ğ²Ğ¸Ğµ: {{ calm }}%
              data:
                group: "crypto-phase"
                tag: "phase-change"
                importance: high

      # English (default)
      - conditions:
          - condition: template
            value_template: "{{ lang == 'en' }}"
        sequence:
          - service: !input notify_service
            data:
              title: >-
                {% set p = new_phase | lower %}
                {% if 'accumulation' in p %}ğŸ“Š Phase: Accumulation
                {% elif 'growth' in p %}ğŸ“ˆ Phase: Growth
                {% elif 'euphoria' in p %}ğŸš€ Phase: Euphoria
                {% elif 'correction' in p %}ğŸ“‰ Phase: Correction
                {% elif 'capitulation' in p %}ğŸ’¥ Phase: Capitulation
                {% else %}ğŸ“Š Market Phase Change{% endif %}
              message: >-
                {{ old_phase }} â†’ {{ new_phase }}

                {% set p = new_phase | lower %}
                {% if 'accumulation' in p %}
                ğŸ’¡ Good time to accumulate positions
                {% elif 'growth' in p %}
                ğŸ“ˆ Market is growing, hold your positions
                {% elif 'euphoria' in p %}
                âš ï¸ Market is overheated, be careful
                {% elif 'correction' in p %}
                ğŸ“‰ Correction, opportunity to buy
                {% elif 'capitulation' in p %}
                ğŸ’¥ Capitulation, extreme fear
                {% endif %}

                Fear & Greed: {{ fear_greed }}
                DCA: {{ dca_signal }}
                Calm: {{ calm }}%
              data:
                group: "crypto-phase"
                tag: "phase-change"
                importance: high

mode: single
