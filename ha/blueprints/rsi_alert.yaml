# =============================================================================
# RSI Alert Blueprint / –ê–ª–µ—Ä—Ç –ø–æ RSI
# =============================================================================
# Sends notification when RSI enters overbought/oversold zones
# –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ RSI –≤—Ö–æ–¥–∏—Ç –≤ –∑–æ–Ω—ã –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏/–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏
# =============================================================================

blueprint:
  name: "RSI Alert / –ê–ª–µ—Ä—Ç RSI"
  description: >-
    Get notified when RSI enters overbought (>70) or oversold (<30) zones.
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ RSI –≤—Ö–æ–¥–∏—Ç –≤ –∑–æ–Ω—É –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏ (>70) –∏–ª–∏ –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏ (<30).
  domain: automation
  author: "Crypto Inspect Add-on"
  source_url: "https://github.com/Mesteriis/crypto-inspector"

  input:
    coin:
      name: "Cryptocurrency / –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞"
      description: >-
        Which coin to monitor.
        –ö–∞–∫—É—é –º–æ–Ω–µ—Ç—É –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å.
      selector:
        select:
          options:
            - BTC
            - ETH
            - SOL
            - ADA
            - XRP
      default: "BTC"

    oversold_threshold:
      name: "Oversold Threshold / –ü–æ—Ä–æ–≥ –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏"
      description: >-
        RSI level considered oversold.
        –£—Ä–æ–≤–µ–Ω—å RSI –¥–ª—è –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏.
      selector:
        number:
          min: 10
          max: 40
          step: 5
      default: 30

    overbought_threshold:
      name: "Overbought Threshold / –ü–æ—Ä–æ–≥ –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏"
      description: >-
        RSI level considered overbought.
        –£—Ä–æ–≤–µ–Ω—å RSI –¥–ª—è –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏.
      selector:
        number:
          min: 60
          max: 90
          step: 5
      default: 70

    notify_service:
      name: "Notification Service / –°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
      description: >-
        The notification service to use.
        –°–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
      selector:
        text:
      default: "notify.mobile_app"

    language:
      name: "Language / –Ø–∑—ã–∫"
      description: "Notification language / –Ø–∑—ã–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
      selector:
        select:
          options:
            - label: "English"
              value: "en"
            - label: "–†—É—Å—Å–∫–∏–π"
              value: "ru"
      default: "ru"

trigger:
  - platform: state
    entity_id: sensor.crypto_inspect_ta_rsi
    not_from:
      - "unknown"
      - "unavailable"
    not_to:
      - "unknown"
      - "unavailable"

condition:
  - condition: template
    value_template: >
      {% set coin = !input coin %}
      {% set data = states('sensor.crypto_inspect_ta_rsi') | from_json | default({}) %}
      {% set rsi = data.get(coin, 50) | float(50) %}
      {% set oversold = !input oversold_threshold | int(30) %}
      {% set overbought = !input overbought_threshold | int(70) %}
      {{ rsi < oversold or rsi > overbought }}

action:
  - variables:
      lang: !input language
      coin: !input coin
      data: "{{ states('sensor.crypto_inspect_ta_rsi') | from_json | default({}) }}"
      rsi: "{{ data.get(coin, 50) | float(50) | round(0) }}"
      oversold: !input oversold_threshold
      overbought: !input overbought_threshold
      is_oversold: "{{ rsi | float < oversold | int }}"
      prices: "{{ states('sensor.crypto_inspect_prices') | from_json | default({}) }}"
      price: "{{ prices.get(coin ~ '/USDT', prices.get(coin, 0)) | float(0) }}"

  - choose:
      # Russian
      - conditions:
          - condition: template
            value_template: "{{ lang == 'ru' }}"
        sequence:
          - service: !input notify_service
            data:
              title: >-
                {% if is_oversold %}
                üìâ {{ coin }} –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω (RSI {{ rsi }})
                {% else %}
                üìà {{ coin }} –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω (RSI {{ rsi }})
                {% endif %}
              message: >-
                {% if is_oversold %}
                {{ coin }} –≤ –∑–æ–Ω–µ –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏!
                RSI: {{ rsi }} (–Ω–∏–∂–µ {{ oversold }})
                –¶–µ–Ω–∞: ${{ '{:,.0f}'.format(price) }}

                üí° –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–∫—É–ø–∫–∏
                {% else %}
                {{ coin }} –≤ –∑–æ–Ω–µ –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏!
                RSI: {{ rsi }} (–≤—ã—à–µ {{ overbought }})
                –¶–µ–Ω–∞: ${{ '{:,.0f}'.format(price) }}

                ‚ö†Ô∏è –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Ñ–∏–∫—Å–∞—Ü–∏—é –ø—Ä–∏–±—ã–ª–∏
                {% endif %}
              data:
                group: "crypto-rsi"
                tag: "rsi-{{ coin }}"
                importance: high

      # English (default)
      - conditions:
          - condition: template
            value_template: "{{ lang == 'en' }}"
        sequence:
          - service: !input notify_service
            data:
              title: >-
                {% if is_oversold %}
                üìâ {{ coin }} Oversold (RSI {{ rsi }})
                {% else %}
                üìà {{ coin }} Overbought (RSI {{ rsi }})
                {% endif %}
              message: >-
                {% if is_oversold %}
                {{ coin }} is oversold!
                RSI: {{ rsi }} (below {{ oversold }})
                Price: ${{ '{:,.0f}'.format(price) }}

                üí° Potential buying opportunity
                {% else %}
                {{ coin }} is overbought!
                RSI: {{ rsi }} (above {{ overbought }})
                Price: ${{ '{:,.0f}'.format(price) }}

                ‚ö†Ô∏è Consider taking profits
                {% endif %}
              data:
                group: "crypto-rsi"
                tag: "rsi-{{ coin }}"
                importance: high

mode: single
