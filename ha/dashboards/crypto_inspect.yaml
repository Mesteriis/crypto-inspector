# =============================================================================
# CRYPTO INSPECT - MAIN DASHBOARD
# =============================================================================
# Single comprehensive dashboard with all 177 sensors
# Uses universal-card with modals for space efficiency
# =============================================================================

views:
  - title: "Crypto Inspect"
    icon: mdi:bitcoin
    path: crypto
    type: custom:grid-layout
    layout:
      grid-template-columns: 1fr 1fr 1fr
      grid-template-rows: auto
      grid-gap: 8px
      mediaquery:
        "(max-width: 800px)":
          grid-template-columns: 1fr
    
    cards:
      # =========================================================================
      # ROW 1: MAIN STATUS CARD
      # =========================================================================
      - type: custom:universal-card
        view_layout:
          grid-column: span 3
        title: "Crypto Inspect"
        subtitle: |
          {% set phase = states('sensor.crypto_inspect_investor_phase') %}
          {% set fg = states('sensor.crypto_inspect_fear_greed') %}
          {{ phase }} ‚Ä¢ F&G: {{ fg }}
        icon: mdi:chart-finance
        theme: glass
        
        badges:
          - entity: sensor.crypto_inspect_do_nothing_ok
            icon: mdi:meditation
            color: |
              {% set v = states('sensor.crypto_inspect_do_nothing_ok') %}
              {{ 'green' if v in ['Yes', '–î–∞', 'true'] else 'orange' }}
          - entity: sensor.crypto_inspect_calm_indicator
            icon: mdi:shield
          - entity: sensor.crypto_inspect_red_flags
            icon: mdi:flag
            color: |
              {{ 'red' if states('sensor.crypto_inspect_red_flags')|int(0) > 0 else 'green' }}
          - entity: sensor.crypto_inspect_dca_signal
            icon: mdi:cash-plus
        
        body_mode: none

      # =========================================================================
      # ROW 2: PRICES + LAZY INVESTOR + MARKET
      # =========================================================================
      
      # --- PRICES ---
      - type: custom:universal-card
        title: "üí∞ –¶–µ–Ω—ã"
        icon: mdi:currency-btc
        theme: minimal
        body_mode: modal
        modal:
          width: 600px
        body:
          cards:
            - type: custom:universal-card
              theme: transparent
              grid:
                columns: 2
                gap: 8px
              body:
                cards:
                  - type: custom:mushroom-template-card
                    primary: "BTC"
                    secondary: |
                      {% set p = states('sensor.crypto_inspect_prices') %}
                      {% if p not in ['unknown','unavailable',''] %}{% set d = p|from_json %}${{ '{:,.0f}'.format(d.get('BTC/USDT',d.get('BTCUSDT',0))|float) }}{% else %}‚Äî{% endif %}
                    icon: mdi:bitcoin
                    icon_color: orange
                  - type: custom:mushroom-template-card
                    primary: "ETH"
                    secondary: |
                      {% set p = states('sensor.crypto_inspect_prices') %}
                      {% if p not in ['unknown','unavailable',''] %}{% set d = p|from_json %}${{ '{:,.0f}'.format(d.get('ETH/USDT',d.get('ETHUSDT',0))|float) }}{% else %}‚Äî{% endif %}
                    icon: mdi:ethereum
                    icon_color: blue
                  - type: custom:mushroom-template-card
                    primary: "24h BTC"
                    secondary: |
                      {% set c = states('sensor.crypto_inspect_changes_24h') %}
                      {% if c not in ['unknown','unavailable',''] %}{% set d = c|from_json %}{{ '{:+.2f}'.format(d.get('BTC/USDT',0)|float) }}%{% else %}‚Äî{% endif %}
                    icon: mdi:percent
                    icon_color: |
                      {% set c = states('sensor.crypto_inspect_changes_24h') %}
                      {% if c not in ['unknown','unavailable',''] %}{% set d = c|from_json %}{{ 'green' if d.get('BTC/USDT',0)|float > 0 else 'red' }}{% else %}grey{% endif %}
                  - type: custom:mushroom-template-card
                    primary: "24h ETH"
                    secondary: |
                      {% set c = states('sensor.crypto_inspect_changes_24h') %}
                      {% if c not in ['unknown','unavailable',''] %}{% set d = c|from_json %}{{ '{:+.2f}'.format(d.get('ETH/USDT',0)|float) }}%{% else %}‚Äî{% endif %}
                    icon: mdi:percent
                    icon_color: |
                      {% set c = states('sensor.crypto_inspect_changes_24h') %}
                      {% if c not in ['unknown','unavailable',''] %}{% set d = c|from_json %}{{ 'green' if d.get('ETH/USDT',0)|float > 0 else 'red' }}{% else %}grey{% endif %}
                  - type: custom:mushroom-template-card
                    primary: "High 24h"
                    secondary: |
                      {% set h = states('sensor.crypto_inspect_highs_24h') %}
                      {% if h not in ['unknown','unavailable',''] %}{% set d = h|from_json %}${{ '{:,.0f}'.format(d.get('BTC/USDT',0)|float) }}{% else %}‚Äî{% endif %}
                    icon: mdi:arrow-up
                    icon_color: green
                  - type: custom:mushroom-template-card
                    primary: "Low 24h"
                    secondary: |
                      {% set l = states('sensor.crypto_inspect_lows_24h') %}
                      {% if l not in ['unknown','unavailable',''] %}{% set d = l|from_json %}${{ '{:,.0f}'.format(d.get('BTC/USDT',0)|float) }}{% else %}‚Äî{% endif %}
                    icon: mdi:arrow-down
                    icon_color: red
        
        # Collapsed view
        grid:
          columns: 2
          gap: 4px
        expanded: false
        header:
          cards:
            - type: custom:mushroom-template-card
              primary: |
                {% set p = states('sensor.crypto_inspect_prices') %}
                {% if p not in ['unknown','unavailable',''] %}{% set d = p|from_json %}${{ '{:,.0f}'.format(d.get('BTC/USDT',d.get('BTCUSDT',0))|float) }}{% else %}‚Äî{% endif %}
              icon: mdi:bitcoin
              icon_color: orange
              layout: horizontal

      # --- LAZY INVESTOR ---
      - type: custom:universal-card
        title: "üßò –ò–Ω–≤–µ—Å—Ç–æ—Ä"
        icon: mdi:meditation
        theme: minimal
        body_mode: modal
        modal:
          width: 500px
        body:
          cards:
            - type: custom:universal-card
              theme: transparent
              grid:
                columns: 2
                gap: 8px
              body:
                cards:
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_do_nothing_ok
                    name: "–ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å?"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_investor_phase
                    name: "–§–∞–∑–∞"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_calm_indicator
                    name: "–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_red_flags
                    name: "–§–ª–∞–≥–∏"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_market_tension
                    name: "–ù–∞–ø—Ä—è–∂—ë–Ω–Ω–æ—Å—Ç—å"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_dca_signal
                    name: "DCA —Å–∏–≥–Ω–∞–ª"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_weekly_insight
                    name: "–ò–Ω—Å–∞–π—Ç"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_next_action_timer
                    name: "–°–ª–µ–¥. –¥–µ–π—Å—Ç–≤–∏–µ"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_investor_recommendation
                    name: "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_hold_signal
                    name: "Hold —Å–∏–≥–Ω–∞–ª"
        
        header:
          cards:
            - type: custom:mushroom-template-card
              primary: |
                {% set v = states('sensor.crypto_inspect_do_nothing_ok') %}
                {{ '‚úì OK' if v in ['Yes','–î–∞','true'] else '‚ö† Act' }}
              icon: mdi:meditation
              icon_color: |
                {% set v = states('sensor.crypto_inspect_do_nothing_ok') %}
                {{ 'green' if v in ['Yes','–î–∞','true'] else 'orange' }}
              layout: horizontal

      # --- MARKET SENTIMENT ---
      - type: custom:universal-card
        title: "üìä –†—ã–Ω–æ–∫"
        icon: mdi:chart-line
        theme: minimal
        body_mode: modal
        modal:
          width: 600px
        body:
          cards:
            - type: custom:universal-card
              theme: transparent
              grid:
                columns: 2
                gap: 8px
              body:
                cards:
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_fear_greed
                    name: "Fear & Greed"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_btc_dominance
                    name: "BTC.D"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_altseason_index
                    name: "Altseason"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_volatility_status
                    name: "–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_market_cycle_phase
                    name: "–¶–∏–∫–ª"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_market_summary
                    name: "Summary"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_stablecoin_flow
                    name: "Stablecoin Flow"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_exchange_flow_signal
                    name: "Exchange Flow"
        
        header:
          cards:
            - type: custom:mushroom-template-card
              primary: "F&G: {{ states('sensor.crypto_inspect_fear_greed') }}"
              icon: mdi:emoticon-neutral
              icon_color: |
                {% set v = states('sensor.crypto_inspect_fear_greed')|int(50) %}
                {% if v <= 25 %}red{% elif v <= 45 %}orange{% elif v <= 55 %}grey{% elif v <= 75 %}green{% else %}blue{% endif %}
              layout: horizontal

      # =========================================================================
      # ROW 3: TECHNICAL + RISK + PORTFOLIO
      # =========================================================================
      
      # --- TECHNICAL ANALYSIS ---
      - type: custom:universal-card
        title: "üìà –¢–µ—Ö. –∞–Ω–∞–ª–∏–∑"
        icon: mdi:chart-areaspline
        theme: minimal
        body_mode: modal
        modal:
          width: 700px
        body:
          cards:
            - type: custom:universal-card
              theme: transparent
              grid:
                columns: 3
                gap: 8px
              body:
                cards:
                  - type: custom:mushroom-template-card
                    primary: "RSI"
                    secondary: |
                      {% set r = states('sensor.crypto_inspect_ta_rsi') %}
                      {% if r not in ['unknown','unavailable',''] %}{% set d = r|from_json %}BTC: {{ d.get('BTC','‚Äî') }}{% else %}‚Äî{% endif %}
                    icon: mdi:chart-line
                  - type: custom:mushroom-template-card
                    primary: "MACD"
                    secondary: |
                      {% set m = states('sensor.crypto_inspect_ta_macd_signal') %}
                      {% if m not in ['unknown','unavailable',''] %}{% set d = m|from_json %}{{ d.get('BTC','‚Äî') }}{% else %}‚Äî{% endif %}
                    icon: mdi:signal
                  - type: custom:mushroom-template-card
                    primary: "–¢—Ä–µ–Ω–¥"
                    secondary: |
                      {% set t = states('sensor.crypto_inspect_ta_trend') %}
                      {% if t not in ['unknown','unavailable',''] %}{% set d = t|from_json %}{{ d.get('BTC','‚Äî') }}{% else %}‚Äî{% endif %}
                    icon: mdi:trending-up
                  - type: custom:mushroom-template-card
                    primary: "BB %"
                    secondary: |
                      {% set b = states('sensor.crypto_inspect_ta_bb_position') %}
                      {% if b not in ['unknown','unavailable',''] %}{% set d = b|from_json %}{{ d.get('BTC','‚Äî') }}%{% else %}‚Äî{% endif %}
                    icon: mdi:chart-bell-curve
                  - type: custom:mushroom-template-card
                    primary: "Support"
                    secondary: |
                      {% set s = states('sensor.crypto_inspect_ta_support') %}
                      {% if s not in ['unknown','unavailable',''] %}{% set d = s|from_json %}${{ '{:,.0f}'.format(d.get('BTC',0)|float) }}{% else %}‚Äî{% endif %}
                    icon: mdi:arrow-down-bold
                    icon_color: green
                  - type: custom:mushroom-template-card
                    primary: "Resistance"
                    secondary: |
                      {% set r = states('sensor.crypto_inspect_ta_resistance') %}
                      {% if r not in ['unknown','unavailable',''] %}{% set d = r|from_json %}${{ '{:,.0f}'.format(d.get('BTC',0)|float) }}{% else %}‚Äî{% endif %}
                    icon: mdi:arrow-up-bold
                    icon_color: red
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_ta_confluence
                    name: "Confluence"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_ta_signal
                    name: "–°–∏–≥–Ω–∞–ª"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_divergences_active
                    name: "–î–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏"
        
        header:
          cards:
            - type: custom:mushroom-template-card
              primary: |
                {% set s = states('sensor.crypto_inspect_ta_signal') %}
                {{ s if s not in ['unknown','unavailable'] else '‚Äî' }}
              icon: mdi:traffic-light
              icon_color: |
                {% set s = states('sensor.crypto_inspect_ta_signal')|lower %}
                {% if 'buy' in s %}green{% elif 'sell' in s %}red{% else %}orange{% endif %}
              layout: horizontal

      # --- RISK ---
      - type: custom:universal-card
        title: "‚ö†Ô∏è –†–∏—Å–∫–∏"
        icon: mdi:shield-alert
        theme: minimal
        body_mode: modal
        modal:
          width: 600px
        body:
          cards:
            - type: custom:universal-card
              theme: transparent
              grid:
                columns: 2
                gap: 8px
              body:
                cards:
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_portfolio_sharpe
                    name: "Sharpe"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_portfolio_sortino
                    name: "Sortino"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_portfolio_max_drawdown
                    name: "Max DD"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_portfolio_current_drawdown
                    name: "Current DD"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_portfolio_var_95
                    name: "VaR 95%"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_dca_risk_score
                    name: "DCA Risk"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_liq_risk_level
                    name: "Liquidation"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_macro_risk_week
                    name: "Macro Risk"
        
        header:
          cards:
            - type: custom:mushroom-template-card
              primary: |
                {% set dd = states('sensor.crypto_inspect_portfolio_current_drawdown') %}
                DD: {{ dd if dd not in ['unknown','unavailable'] else '‚Äî' }}%
              icon: mdi:trending-down
              icon_color: |
                {% set dd = states('sensor.crypto_inspect_portfolio_current_drawdown')|float(0) %}
                {% if dd > 20 %}red{% elif dd > 10 %}orange{% else %}green{% endif %}
              layout: horizontal

      # --- PORTFOLIO ---
      - type: custom:universal-card
        title: "üíº –ü–æ—Ä—Ç—Ñ–µ–ª—å"
        icon: mdi:wallet
        theme: minimal
        body_mode: modal
        modal:
          width: 600px
        body:
          cards:
            - type: custom:universal-card
              theme: transparent
              grid:
                columns: 2
                gap: 8px
              body:
                cards:
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_bybit_balance
                    name: "–ë–∞–ª–∞–Ω—Å"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_bybit_total_portfolio
                    name: "–í—Å–µ–≥–æ"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_bybit_pnl_24h
                    name: "P&L 24h"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_bybit_pnl_7d
                    name: "P&L 7d"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_bybit_unrealized_pnl
                    name: "Unrealized"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_bybit_open_positions
                    name: "–ü–æ–∑–∏—Ü–∏–∏"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_bybit_earn_balance
                    name: "Earn"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_bybit_earn_apy
                    name: "APY"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_goal_progress
                    name: "–¶–µ–ª—å %"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_goal_days_estimate
                    name: "–î–Ω–µ–π –¥–æ —Ü–µ–ª–∏"
        
        header:
          cards:
            - type: custom:mushroom-template-card
              primary: |
                {% set b = states('sensor.crypto_inspect_bybit_balance') %}
                ${{ '{:,.0f}'.format(b|float) if b not in ['unknown','unavailable'] else '‚Äî' }}
              icon: mdi:wallet
              icon_color: green
              layout: horizontal

      # =========================================================================
      # ROW 4: TRADFI + WHALES + GAS
      # =========================================================================
      
      # --- TRADITIONAL MARKETS ---
      - type: custom:universal-card
        title: "üèõ TradFi"
        icon: mdi:bank
        theme: minimal
        body_mode: modal
        modal:
          width: 600px
        body:
          cards:
            - type: custom:universal-card
              theme: transparent
              grid:
                columns: 4
                gap: 8px
              body:
                cards:
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_gold_price
                    name: "Gold"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_silver_price
                    name: "Silver"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_sp500_price
                    name: "S&P500"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_nasdaq_price
                    name: "NASDAQ"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_dxy_index
                    name: "DXY"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_eur_usd
                    name: "EUR/USD"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_oil_brent
                    name: "Brent"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_natural_gas
                    name: "Gas"
        
        header:
          cards:
            - type: custom:mushroom-template-card
              primary: |
                {% set g = states('sensor.crypto_inspect_gold_price') %}
                Gold: ${{ '{:,.0f}'.format(g|float) if g not in ['unknown','unavailable'] else '‚Äî' }}
              icon: mdi:gold
              icon_color: amber
              layout: horizontal

      # --- WHALES & ON-CHAIN ---
      - type: custom:universal-card
        title: "üêã –ö–∏—Ç—ã"
        icon: mdi:fish
        theme: minimal
        body_mode: modal
        modal:
          width: 500px
        body:
          cards:
            - type: custom:universal-card
              theme: transparent
              grid:
                columns: 2
                gap: 8px
              body:
                cards:
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_whale_net_flow
                    name: "Net Flow"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_whale_activity_level
                    name: "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_whale_alert
                    name: "Alert"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_whale_signal
                    name: "–°–∏–≥–Ω–∞–ª"
        
        header:
          cards:
            - type: custom:mushroom-template-card
              primary: |
                {% set w = states('sensor.crypto_inspect_whale_activity_level') %}
                {{ w if w not in ['unknown','unavailable'] else '‚Äî' }}
              icon: mdi:fish
              icon_color: |
                {% set w = states('sensor.crypto_inspect_whale_activity_level')|lower %}
                {% if 'high' in w %}red{% elif 'medium' in w %}orange{% else %}green{% endif %}
              layout: horizontal

      # --- GAS & CORRELATION ---
      - type: custom:universal-card
        title: "‚õΩ Gas & –ö–æ—Ä—Ä."
        icon: mdi:gas-station
        theme: minimal
        body_mode: modal
        modal:
          width: 500px
        body:
          cards:
            - type: custom:universal-card
              theme: transparent
              grid:
                columns: 2
                gap: 8px
              body:
                cards:
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_eth_gas_slow
                    name: "Slow"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_eth_gas_standard
                    name: "Standard"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_eth_gas_fast
                    name: "Fast"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_eth_gas_status
                    name: "Status"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_btc_eth_correlation
                    name: "BTC/ETH"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_btc_sp500_correlation
                    name: "BTC/S&P"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_btc_gold_correlation
                    name: "BTC/Gold"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_correlation_status
                    name: "Status"
        
        header:
          cards:
            - type: custom:mushroom-template-card
              primary: |
                {% set g = states('sensor.crypto_inspect_eth_gas_standard') %}
                {{ g if g not in ['unknown','unavailable'] else '‚Äî' }} gwei
              icon: mdi:gas-station
              icon_color: |
                {% set g = states('sensor.crypto_inspect_eth_gas_standard')|int(50) %}
                {% if g < 20 %}green{% elif g < 50 %}orange{% else %}red{% endif %}
              layout: horizontal

      # =========================================================================
      # ROW 5: AI + ALERTS + SYSTEM (conditional)
      # =========================================================================
      
      # --- AI ANALYSIS ---
      - type: custom:universal-card
        title: "ü§ñ AI"
        icon: mdi:brain
        theme: minimal
        body_mode: modal
        modal:
          width: 600px
        body:
          cards:
            - type: custom:universal-card
              theme: transparent
              grid:
                columns: 2
                gap: 8px
              body:
                cards:
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_ai_sentiment
                    name: "Sentiment"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_ai_recommendation
                    name: "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_ai_confidence
                    name: "Confidence"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_ai_last_analysis
                    name: "–ü–æ—Å–ª. –∞–Ω–∞–ª–∏–∑"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_ai_price_forecasts_24h
                    name: "Forecast 24h"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_ai_provider
                    name: "Provider"
        
        header:
          cards:
            - type: custom:mushroom-template-card
              primary: |
                {% set r = states('sensor.crypto_inspect_ai_recommendation') %}
                {{ r if r not in ['unknown','unavailable'] else '‚Äî' }}
              icon: mdi:brain
              icon_color: purple
              layout: horizontal

      # --- ALERTS ---
      - type: custom:universal-card
        title: "üîî –ê–ª–µ—Ä—Ç—ã"
        icon: mdi:bell
        theme: minimal
        body_mode: modal
        modal:
          width: 500px
        body:
          cards:
            - type: custom:universal-card
              theme: transparent
              grid:
                columns: 2
                gap: 8px
              body:
                cards:
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_active_alerts_count
                    name: "–ê–∫—Ç–∏–≤–Ω—ã–µ"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_pending_alerts_count
                    name: "Pending"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_pending_alerts_critical
                    name: "Critical"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_signals_today
                    name: "–°–∏–≥–Ω–∞–ª—ã"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_signals_win_rate
                    name: "Win Rate"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_notification_mode
                    name: "–†–µ–∂–∏–º"
        
        header:
          cards:
            - type: custom:mushroom-template-card
              primary: |
                {% set a = states('sensor.crypto_inspect_active_alerts_count')|int(0) %}
                {{ a }} –∞–ª–µ—Ä—Ç–æ–≤
              icon: mdi:bell-badge
              icon_color: |
                {% set a = states('sensor.crypto_inspect_active_alerts_count')|int(0) %}
                {{ 'red' if a > 0 else 'green' }}
              layout: horizontal

      # --- SYSTEM ---
      - type: custom:universal-card
        title: "‚öôÔ∏è –°–∏—Å—Ç–µ–º–∞"
        icon: mdi:cog
        theme: minimal
        body_mode: modal
        modal:
          width: 500px
        body:
          cards:
            - type: custom:universal-card
              theme: transparent
              grid:
                columns: 2
                gap: 8px
              body:
                cards:
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_sync_status
                    name: "Sync"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_last_sync
                    name: "Last Sync"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_candles_count
                    name: "Candles"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_api_status
                    name: "API"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_database_status
                    name: "Database"
                  - type: custom:mushroom-entity-card
                    entity: sensor.crypto_inspect_version
                    name: "Version"
        
        header:
          cards:
            - type: custom:mushroom-template-card
              primary: |
                {% set s = states('sensor.crypto_inspect_sync_status') %}
                {{ s if s not in ['unknown','unavailable'] else '‚Äî' }}
              icon: mdi:sync
              icon_color: |
                {% set s = states('sensor.crypto_inspect_sync_status')|lower %}
                {{ 'green' if 'ok' in s or 'success' in s else 'orange' }}
              layout: horizontal

      # =========================================================================
      # CONDITIONAL: SIGNAL BAR (only when signals exist)
      # =========================================================================
      - type: conditional
        conditions:
          - condition: template
            value_template: |
              {% set a = states('sensor.crypto_inspect_active_alerts_count')|int(0) %}
              {% set f = states('sensor.crypto_inspect_red_flags')|int(0) %}
              {{ a > 0 or f > 0 }}
        card:
          type: custom:universal-card
          view_layout:
            grid-column: span 3
          title: "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï"
          icon: mdi:alert
          theme: ember
          body_mode: expand
          expanded: true
          grid:
            columns: 4
            gap: 8px
          body:
            cards:
              - type: custom:mushroom-template-card
                primary: "–ê–ª–µ—Ä—Ç—ã"
                secondary: "{{ states('sensor.crypto_inspect_active_alerts_count')|int(0) }}"
                icon: mdi:bell-alert
                icon_color: red
              - type: custom:mushroom-template-card
                primary: "–§–ª–∞–≥–∏"
                secondary: "{{ states('sensor.crypto_inspect_red_flags')|int(0) }}"
                icon: mdi:flag
                icon_color: red
              - type: custom:mushroom-template-card
                primary: "DCA"
                secondary: "{{ states('sensor.crypto_inspect_dca_signal') }}"
                icon: mdi:cash-plus
              - type: custom:mushroom-template-card
                primary: "–î–µ–π—Å—Ç–≤–∏–µ"
                secondary: "{{ states('sensor.crypto_inspect_investor_recommendation') }}"
                icon: mdi:clipboard-check
