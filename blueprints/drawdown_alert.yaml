# =============================================================================
# Drawdown Alert Blueprint / ÐÐ»ÐµÑ€Ñ‚ Ð¿Ñ€Ð¾ÑÐ°Ð´ÐºÐ¸
# =============================================================================
# Sends notification when portfolio drawdown exceeds threshold
# ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð³Ð´Ð° Ð¿Ñ€Ð¾ÑÐ°Ð´ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ñ„ÐµÐ»Ñ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°ÐµÑ‚ Ð¿Ð¾Ñ€Ð¾Ð³
# =============================================================================

blueprint:
  name: "Drawdown Alert / ÐÐ»ÐµÑ€Ñ‚ Ð¿Ñ€Ð¾ÑÐ°Ð´ÐºÐ¸"
  description: >-
    Get notified when your portfolio drawdown exceeds a threshold.
    Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð³Ð´Ð° Ð¿Ñ€Ð¾ÑÐ°Ð´ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ñ„ÐµÐ»Ñ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°ÐµÑ‚ Ð¿Ð¾Ñ€Ð¾Ð³.
  domain: automation
  author: "Crypto Inspect Add-on"
  source_url: "https://github.com/Mesteriis/crypto-inspector"

  input:
    drawdown_threshold:
      name: "Drawdown Threshold / ÐŸÐ¾Ñ€Ð¾Ð³ Ð¿Ñ€Ð¾ÑÐ°Ð´ÐºÐ¸"
      description: >-
        Alert when drawdown exceeds this percentage.
        ÐÐ»ÐµÑ€Ñ‚ ÐºÐ¾Ð³Ð´Ð° Ð¿Ñ€Ð¾ÑÐ°Ð´ÐºÐ° Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°ÐµÑ‚ ÑÑ‚Ð¾Ñ‚ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚.
      selector:
        number:
          min: 5
          max: 50
          step: 5
          unit_of_measurement: "%"
      default: 15

    notify_service:
      name: "Notification Service / Ð¡ÐµÑ€Ð²Ð¸Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹"
      description: >-
        The notification service to use.
        Ð¡ÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹.
      selector:
        text:
      default: "notify.mobile_app"

    language:
      name: "Language / Ð¯Ð·Ñ‹Ðº"
      description: "Notification language / Ð¯Ð·Ñ‹Ðº ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹"
      selector:
        select:
          options:
            - label: "English"
              value: "en"
            - label: "Ð ÑƒÑÑÐºÐ¸Ð¹"
              value: "ru"
      default: "ru"

    severity_levels:
      name: "Enable Severity Levels / Ð£Ñ€Ð¾Ð²Ð½Ð¸ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾ÑÑ‚Ð¸"
      description: >-
        Send different alerts for Warning (threshold), Danger (+5%), Critical (+10%).
        ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð°Ð»ÐµÑ€Ñ‚Ñ‹ Ð´Ð»Ñ Warning, Danger (+5%), Critical (+10%).
      selector:
        boolean:
      default: true

trigger:
  - platform: numeric_state
    entity_id: sensor.crypto_inspect_portfolio_current_drawdown
    above: !input drawdown_threshold
    for:
      minutes: 5

condition: []

action:
  - variables:
      lang: !input language
      threshold: !input drawdown_threshold
      current_dd: "{{ states('sensor.crypto_inspect_portfolio_current_drawdown') | float(0) | abs }}"
      max_dd: "{{ states('sensor.crypto_inspect_portfolio_max_drawdown') | float(0) | abs }}"
      portfolio_value: "{{ states('sensor.crypto_inspect_bybit_total_portfolio') | float(0) }}"
      risk_status: "{{ states('sensor.crypto_inspect_risk_status') }}"
      fear_greed: "{{ states('sensor.crypto_inspect_fear_greed') }}"
      severity_enabled: !input severity_levels
      severity: >-
        {% set dd = current_dd | float %}
        {% set t = threshold | int %}
        {% if dd >= t + 10 %}critical
        {% elif dd >= t + 5 %}danger
        {% else %}warning{% endif %}

  - choose:
      # Russian
      - conditions:
          - condition: template
            value_template: "{{ lang == 'ru' }}"
        sequence:
          - service: !input notify_service
            data:
              title: >-
                {% if severity == 'critical' %}
                ðŸš¨ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ Ð¿Ñ€Ð¾ÑÐ°Ð´ÐºÐ°: {{ current_dd | round(1) }}%
                {% elif severity == 'danger' %}
                âš ï¸ ÐžÐŸÐÐ¡ÐÐÐ¯ Ð¿Ñ€Ð¾ÑÐ°Ð´ÐºÐ°: {{ current_dd | round(1) }}%
                {% else %}
                âš ï¸ ÐŸÑ€Ð¾ÑÐ°Ð´ÐºÐ°: {{ current_dd | round(1) }}%
                {% endif %}
              message: >-
                ÐŸÐ¾Ñ€Ñ‚Ñ„ÐµÐ»ÑŒ ÑƒÐ¿Ð°Ð» Ð½Ð° {{ current_dd | round(1) }}% Ð¾Ñ‚ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼Ð°

                ðŸ’° Ð¢ÐµÐºÑƒÑ‰Ð°Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: ${{ '{:,.0f}'.format(portfolio_value) }}
                ðŸ“‰ ÐœÐ°ÐºÑ. Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ñ€Ð¾ÑÐ°Ð´ÐºÐ°: {{ max_dd | round(1) }}%
                ðŸ”´ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ñ€Ð¸ÑÐºÐ°: {{ risk_status }}
                ðŸ˜± Fear & Greed: {{ fear_greed }}

                {% if severity == 'critical' %}
                â— ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð™ Ð£Ð ÐžÐ’Ð•ÐÐ¬ - Ñ€Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ Ð·Ð°Ñ‰Ð¸Ñ‚Ð½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ!
                {% elif severity == 'danger' %}
                âš ï¸ ÐžÐ¿Ð°ÑÐ½Ñ‹Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ - Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€ÑŒÑ‚Ðµ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸ÑŽ
                {% else %}
                â„¹ï¸ ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½ Ð¿Ð¾Ñ€Ð¾Ð³ Ð¿Ñ€Ð¾ÑÐ°Ð´ÐºÐ¸ {{ threshold }}%
                {% endif %}
              data:
                group: "crypto-risk"
                tag: "drawdown-alert"
                importance: >-
                  {% if severity == 'critical' %}critical
                  {% elif severity == 'danger' %}high
                  {% else %}default{% endif %}

      # English (default)
      - conditions:
          - condition: template
            value_template: "{{ lang == 'en' }}"
        sequence:
          - service: !input notify_service
            data:
              title: >-
                {% if severity == 'critical' %}
                ðŸš¨ CRITICAL Drawdown: {{ current_dd | round(1) }}%
                {% elif severity == 'danger' %}
                âš ï¸ DANGER Drawdown: {{ current_dd | round(1) }}%
                {% else %}
                âš ï¸ Drawdown Alert: {{ current_dd | round(1) }}%
                {% endif %}
              message: >-
                Portfolio dropped {{ current_dd | round(1) }}% from peak

                ðŸ’° Current Value: ${{ '{:,.0f}'.format(portfolio_value) }}
                ðŸ“‰ Max Historical DD: {{ max_dd | round(1) }}%
                ðŸ”´ Risk Status: {{ risk_status }}
                ðŸ˜± Fear & Greed: {{ fear_greed }}

                {% if severity == 'critical' %}
                â— CRITICAL LEVEL - Consider protective actions!
                {% elif severity == 'danger' %}
                âš ï¸ Dangerous level - Monitor the situation
                {% else %}
                â„¹ï¸ Drawdown threshold {{ threshold }}% exceeded
                {% endif %}
              data:
                group: "crypto-risk"
                tag: "drawdown-alert"
                importance: >-
                  {% if severity == 'critical' %}critical
                  {% elif severity == 'danger' %}high
                  {% else %}default{% endif %}

mode: single
