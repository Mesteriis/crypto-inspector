# =============================================================================
# Morning Briefing Blueprint
# =============================================================================
# Sends a comprehensive morning report with overnight changes and today's outlook
#
# Usage: Import into Home Assistant blueprints and configure notification service
# =============================================================================

blueprint:
  name: "Crypto Morning Briefing / Ð£Ñ‚Ñ€ÐµÐ½Ð½Ð¸Ð¹ Ð±Ñ€Ð¸Ñ„Ð¸Ð½Ð³"
  description: >-
    Send a comprehensive morning briefing with overnight market changes.
    ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑÐ½Ñ‹Ð¹ ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ð¹ Ð±Ñ€Ð¸Ñ„Ð¸Ð½Ð³ Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÐ¼Ð¸ Ð·Ð° Ð½Ð¾Ñ‡ÑŒ.
  domain: automation
  author: "Crypto Inspect Add-on"
  source_url: "https://github.com/Mesteriis/crypto-inspector"

  input:
    notify_device:
      name: "Notification Service / Ð¡ÐµÑ€Ð²Ð¸Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹"
      description: >-
        The notification service to use.
        Ð¡ÐµÑ€Ð²Ð¸Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸.
      selector:
        text:
      default: "notify.mobile_app"

    send_time:
      name: "Send Time / Ð’Ñ€ÐµÐ¼Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸"
      description: >-
        Time to send the morning briefing.
        Ð’Ñ€ÐµÐ¼Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑƒÑ‚Ñ€ÐµÐ½Ð½ÐµÐ³Ð¾ Ð±Ñ€Ð¸Ñ„Ð¸Ð½Ð³Ð°.
      selector:
        time:
      default: "08:00:00"

    language:
      name: "Language / Ð¯Ð·Ñ‹Ðº"
      description: >-
        Notification language.
        Ð¯Ð·Ñ‹Ðº ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹.
      selector:
        select:
          options:
            - label: "English"
              value: "en"
            - label: "Ð ÑƒÑÑÐºÐ¸Ð¹"
              value: "ru"
      default: "ru"

    skip_weekends:
      name: "Skip Weekends / ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ñ‹Ðµ"
      description: >-
        Skip briefings on weekends.
        ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð±Ñ€Ð¸Ñ„Ð¸Ð½Ð³Ð¸ Ð² Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ñ‹Ðµ.
      selector:
        boolean:
      default: false

trigger:
  - platform: time
    at: !input send_time

condition:
  - condition: template
    value_template: >-
      {% set skip_weekends = skip_weekends | default(false) %}
      {% if skip_weekends %}
        {{ now().weekday() < 5 }}
      {% else %}
        true
      {% endif %}

action:
  - variables:
      lang: !input language
      btc_price: "{{ states('sensor.crypto_inspect_prices') }}"
      btc_change: "{{ state_attr('sensor.crypto_inspect_changes_24h', 'BTC/USDT') | default('N/A') }}"
      fear_greed: "{{ states('sensor.crypto_inspect_fear_greed') }}"
      market_pulse: "{{ states('sensor.crypto_inspect_market_pulse') }}"
      today_action: "{{ states('sensor.crypto_inspect_today_action') }}"

  - choose:
      # Russian
      - conditions:
          - condition: template
            value_template: "{{ lang == 'ru' }}"
        sequence:
          - service: !input notify_device
            data:
              title: "â˜€ï¸ Ð”Ð¾Ð±Ñ€Ð¾Ðµ ÑƒÑ‚Ñ€Ð¾! ÐšÑ€Ð¸Ð¿Ñ‚Ð¾-Ð±Ñ€Ð¸Ñ„Ð¸Ð½Ð³"
              message: >-
                ðŸŒ™ Ð—Ð° Ð½Ð¾Ñ‡ÑŒ:
                BTC: ${{ btc_price }} ({{ btc_change }}%)
                Ð¡Ñ‚Ñ€Ð°Ñ…/Ð–Ð°Ð´Ð½Ð¾ÑÑ‚ÑŒ: {{ fear_greed }}

                ðŸ“ˆ Ð Ñ‹Ð½Ð¾Ðº: {{ market_pulse }}
                {{ state_attr('sensor.crypto_inspect_market_pulse', 'reason_ru') }}

                ðŸŽ¯ Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ: {{ today_action }}
                {{ state_attr('sensor.crypto_inspect_today_action', 'details_ru') }}

                ðŸ’¼ ÐŸÐ¾Ñ€Ñ‚Ñ„ÐµÐ»ÑŒ: {{ states('sensor.crypto_inspect_portfolio_health') }}
              data:
                group: "crypto-briefing"
                tag: "morning-briefing"
                importance: default

      # English (default)
      - conditions:
          - condition: template
            value_template: "{{ lang == 'en' }}"
        sequence:
          - service: !input notify_device
            data:
              title: "â˜€ï¸ Good Morning! Crypto Briefing"
              message: >-
                ðŸŒ™ Overnight:
                BTC: ${{ btc_price }} ({{ btc_change }}%)
                Fear/Greed: {{ fear_greed }}

                ðŸ“ˆ Market: {{ market_pulse }}
                {{ state_attr('sensor.crypto_inspect_market_pulse', 'reason') }}

                ðŸŽ¯ Today: {{ today_action }}
                {{ state_attr('sensor.crypto_inspect_today_action', 'details') }}

                ðŸ’¼ Portfolio: {{ states('sensor.crypto_inspect_portfolio_health') }}
              data:
                group: "crypto-briefing"
                tag: "morning-briefing"
                importance: default

mode: single
