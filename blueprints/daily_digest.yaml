# =============================================================================
# Daily Digest Blueprint
# =============================================================================
# Sends aggregated daily notifications at a specified time
# Collects all non-critical alerts from the day and sends them as one message
#
# Usage: Import into Home Assistant blueprints and configure notification service
# =============================================================================

blueprint:
  name: "Crypto Daily Digest / Ğ•Ğ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğ¹ Ğ´Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚"
  description: >-
    Send a daily digest of all non-critical crypto alerts.
    ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğ¹ Ğ´Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚ Ğ²ÑĞµÑ… Ğ½ĞµĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾-Ğ¾Ğ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ğ¹.
  domain: automation
  author: "Crypto Inspect Add-on"
  source_url: "https://github.com/Mesteriis/crypto-inspector"

  input:
    notify_device:
      name: "Notification Service / Ğ¡ĞµÑ€Ğ²Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹"
      description: >-
        The notification service to use.
        Ğ¡ĞµÑ€Ğ²Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸.
      selector:
        text:
      default: "notify.mobile_app"

    send_time:
      name: "Send Time / Ğ’Ñ€ĞµĞ¼Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸"
      description: >-
        Time to send the daily digest.
        Ğ’Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚Ğ°.
      selector:
        time:
      default: "20:00:00"

    language:
      name: "Language / Ğ¯Ğ·Ñ‹Ğº"
      description: >-
        Notification language.
        Ğ¯Ğ·Ñ‹Ğº ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹.
      selector:
        select:
          options:
            - label: "English"
              value: "en"
            - label: "Ğ ÑƒÑÑĞºĞ¸Ğ¹"
              value: "ru"
      default: "ru"

    min_alerts:
      name: "Minimum Alerts / ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ¾Ğ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ğ¹"
      description: >-
        Minimum number of alerts to send digest (skip if fewer).
        ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ğ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ´Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚Ğ°.
      selector:
        number:
          min: 0
          max: 20
          mode: slider
      default: 1

trigger:
  - platform: time
    at: !input send_time

condition: []

action:
  - variables:
      lang: !input language
      active_alerts: "{{ states.sensor | selectattr('entity_id', 'match', 'sensor\\.crypto_inspect_.*alert.*') | list | count }}"
      triggered_24h: "{{ states('sensor.crypto_inspect_triggered_alerts_24h') | default('0') }}"

  - choose:
      # Russian
      - conditions:
          - condition: template
            value_template: "{{ lang == 'ru' }}"
        sequence:
          - service: !input notify_device
            data:
              title: "ğŸ“Š Ğ•Ğ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğ¹ ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾-Ğ´Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚"
              message: >-
                {{ active_alerts }} Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¾Ğ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ğ¹
                {% set triggered = triggered_24h | int(0) %}
                {% if triggered > 0 %}ğŸ”” {{ triggered }} ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ¾ Ğ·Ğ° 24Ñ‡{% endif %}

                ğŸ“ˆ Fear & Greed: {{ states('sensor.crypto_inspect_fear_greed') }}
                ğŸ¯ Ğ¤Ğ°Ğ·Ğ°: {{ states('sensor.crypto_inspect_investor_phase') }}
              data:
                group: "crypto-digest"
                tag: "daily-digest"
                importance: default

      # English (default)
      - conditions:
          - condition: template
            value_template: "{{ lang == 'en' }}"
        sequence:
          - service: !input notify_device
            data:
              title: "ğŸ“Š Daily Crypto Digest"
              message: >-
                {{ active_alerts }} active alerts
                {% set triggered = triggered_24h | int(0) %}
                {% if triggered > 0 %}ğŸ”” {{ triggered }} triggered in 24h{% endif %}

                ğŸ“ˆ Fear & Greed: {{ states('sensor.crypto_inspect_fear_greed') }}
                ğŸ¯ Phase: {{ states('sensor.crypto_inspect_investor_phase') }}
              data:
                group: "crypto-digest"
                tag: "daily-digest"
                importance: default

mode: single
