# =============================================================================
# Daily Digest Blueprint
# =============================================================================
# Sends aggregated daily notifications at a specified time
# Collects all non-critical alerts from the day and sends them as one message
#
# Usage: Import into Home Assistant blueprints and configure notification service
# =============================================================================

blueprint:
  name: "Crypto Daily Digest / Ğ•Ğ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğ¹ Ğ´Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚"
  description: >-
    Send a daily digest of all non-critical crypto alerts.
    ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğ¹ Ğ´Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚ Ğ²ÑĞµÑ… Ğ½ĞµĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾-Ğ¾Ğ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ğ¹.
  domain: automation
  author: "Crypto Inspect Add-on"
  source_url: "https://github.com/Mesteriis/crypto-inspector"

  input:
    notify_device:
      name: "Notification Service / Ğ¡ĞµÑ€Ğ²Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹"
      description: >-
        The notification service to use.
        Ğ¡ĞµÑ€Ğ²Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸.
      selector:
        text:
      default: "notify.mobile_app"

    send_time:
      name: "Send Time / Ğ’Ñ€ĞµĞ¼Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸"
      description: >-
        Time to send the daily digest.
        Ğ’Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚Ğ°.
      selector:
        time:
      default: "20:00:00"

    language:
      name: "Language / Ğ¯Ğ·Ñ‹Ğº"
      description: >-
        Notification language.
        Ğ¯Ğ·Ñ‹Ğº ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹.
      selector:
        select:
          options:
            - label: "English"
              value: "en"
            - label: "Ğ ÑƒÑÑĞºĞ¸Ğ¹"
              value: "ru"
      default: "ru"

    min_alerts:
      name: "Minimum Alerts / ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ¾Ğ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ğ¹"
      description: >-
        Minimum number of alerts to send digest (skip if fewer).
        ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ğ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ´Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚Ğ°.
      selector:
        number:
          min: 0
          max: 20
          mode: slider
      default: 1

trigger:
  - platform: time
    at: !input send_time

condition:
  - condition: numeric_state
    entity_id: sensor.crypto_inspect_pending_alerts_count
    above: !input min_alerts

action:
  - variables:
      lang: !input language
      pending: "{{ states('sensor.crypto_inspect_pending_alerts_count') | int(0) }}"
      critical: "{{ states('sensor.crypto_inspect_pending_alerts_critical') | int(0) }}"
      digest_ready: "{{ states('sensor.crypto_inspect_daily_digest_ready') }}"

  - choose:
      # Russian
      - conditions:
          - condition: template
            value_template: "{{ lang == 'ru' }}"
        sequence:
          - service: !input notify_device
            data:
              title: "ğŸ“Š Ğ•Ğ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğ¹ ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾-Ğ´Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚"
              message: >-
                {{ pending }} Ğ¾Ğ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ğ¹ Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
                {% if critical > 0 %}âš ï¸ {{ critical }} ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ…{% endif %}

                {{ state_attr('sensor.crypto_inspect_market_pulse', 'reason_ru') }}

                ğŸ“ˆ Ğ Ñ‹Ğ½Ğ¾Ğº: {{ states('sensor.crypto_inspect_market_pulse') }}
                ğŸ¯ Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ: {{ states('sensor.crypto_inspect_today_action') }}
              data:
                group: "crypto-digest"
                tag: "daily-digest"
                importance: default

      # English (default)
      - conditions:
          - condition: template
            value_template: "{{ lang == 'en' }}"
        sequence:
          - service: !input notify_device
            data:
              title: "ğŸ“Š Daily Crypto Digest"
              message: >-
                {{ pending }} alerts today
                {% if critical > 0 %}âš ï¸ {{ critical }} critical{% endif %}

                {{ state_attr('sensor.crypto_inspect_market_pulse', 'reason') }}

                ğŸ“ˆ Market: {{ states('sensor.crypto_inspect_market_pulse') }}
                ğŸ¯ Action: {{ states('sensor.crypto_inspect_today_action') }}
              data:
                group: "crypto-digest"
                tag: "daily-digest"
                importance: default

mode: single
