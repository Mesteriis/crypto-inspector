# =============================================================================
# Weekly Summary Blueprint / –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è —Å–≤–æ–¥–∫–∞
# =============================================================================
# Sends comprehensive weekly crypto summary every Sunday
# –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—É—é —Å–≤–æ–¥–∫—É –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
# =============================================================================

blueprint:
  name: "Weekly Crypto Summary / –ù–µ–¥–µ–ª—å–Ω–∞—è —Å–≤–æ–¥–∫–∞"
  description: >-
    Receive a comprehensive weekly summary of your crypto portfolio and market.
    –ü–æ–ª—É—á–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—É—é –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—É—é —Å–≤–æ–¥–∫—É –ø–æ –ø–æ—Ä—Ç—Ñ–µ–ª—é –∏ —Ä—ã–Ω–∫—É.
  domain: automation
  author: "Crypto Inspect Add-on"
  source_url: "https://github.com/Mesteriis/crypto-inspector"

  input:
    notify_service:
      name: "Notification Service / –°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
      description: >-
        The notification service to use.
        –°–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
      selector:
        text:
      default: "notify.mobile_app"

    send_time:
      name: "Send Time / –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏"
      description: >-
        Time to send the weekly summary (Sunday).
        –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–π —Å–≤–æ–¥–∫–∏ (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ).
      selector:
        time:
      default: "18:00:00"

    language:
      name: "Language / –Ø–∑—ã–∫"
      description: "Notification language / –Ø–∑—ã–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
      selector:
        select:
          options:
            - label: "English"
              value: "en"
            - label: "–†—É—Å—Å–∫–∏–π"
              value: "ru"
      default: "ru"

trigger:
  - platform: time
    at: !input send_time

condition:
  # Only on Sunday (weekday 6)
  - condition: template
    value_template: "{{ now().weekday() == 6 }}"

action:
  - variables:
      lang: !input language
      # Portfolio
      portfolio_value: "{{ states('sensor.crypto_inspect_bybit_total_portfolio') | float(0) }}"
      pnl_7d: "{{ states('sensor.crypto_inspect_bybit_pnl_7d') | float(0) }}"
      goal_progress: "{{ states('sensor.crypto_inspect_goal_progress') | float(0) }}"
      # Market
      fear_greed: "{{ states('sensor.crypto_inspect_fear_greed') }}"
      investor_phase: "{{ states('sensor.crypto_inspect_investor_phase') }}"
      btc_dominance: "{{ states('sensor.crypto_inspect_btc_dominance') | float(0) }}"
      altseason: "{{ states('sensor.crypto_inspect_altseason_index') }}"
      # Signals
      dca_signal: "{{ states('sensor.crypto_inspect_dca_signal') }}"
      weekly_insight: "{{ states('sensor.crypto_inspect_weekly_insight') }}"
      # Risk
      sharpe: "{{ states('sensor.crypto_inspect_portfolio_sharpe') }}"
      max_dd: "{{ states('sensor.crypto_inspect_portfolio_max_drawdown') }}"
      # Backtest
      best_strategy: "{{ states('sensor.crypto_inspect_backtest_best_strategy') }}"
      # Next week
      macro_risk: "{{ states('sensor.crypto_inspect_macro_risk_week') }}"
      next_macro: "{{ states('sensor.crypto_inspect_next_macro_event') }}"
      days_fomc: "{{ states('sensor.crypto_inspect_days_to_fomc') }}"

  - choose:
      # Russian
      - conditions:
          - condition: template
            value_template: "{{ lang == 'ru' }}"
        sequence:
          - service: !input notify_service
            data:
              title: "üìä –ù–µ–¥–µ–ª—å–Ω–∞—è –∫—Ä–∏–ø—Ç–æ-—Å–≤–æ–¥–∫–∞"
              message: >-
                üìà –ü–û–†–¢–§–ï–õ–¨
                –°—Ç–æ–∏–º–æ—Å—Ç—å: ${{ '{:,.0f}'.format(portfolio_value) }}
                P&L –∑–∞ –Ω–µ–¥–µ–ª—é: {{ '+' if pnl_7d > 0 else '' }}{{ pnl_7d | round(1) }}%
                –ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–∏: {{ goal_progress | round(0) }}%

                üå°Ô∏è –†–´–ù–û–ö
                Fear & Greed: {{ fear_greed }}
                –§–∞–∑–∞: {{ investor_phase }}
                BTC.D: {{ btc_dominance | round(1) }}%
                –ê–ª—å—Ç—Å–µ–∑–æ–Ω: {{ altseason }}

                üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
                DCA: {{ dca_signal }}
                {{ weekly_insight }}

                ‚ö†Ô∏è –†–ò–°–ö–ò
                Sharpe: {{ sharpe }}
                –ú–∞–∫—Å. –ø—Ä–æ—Å–∞–¥–∫–∞: {{ max_dd }}%

                üìÖ –°–õ–ï–î–£–Æ–©–ê–Ø –ù–ï–î–ï–õ–Ø
                –ú–∞–∫—Ä–æ-—Ä–∏—Å–∫: {{ macro_risk }}
                {% if days_fomc and days_fomc | int < 14 %}
                FOMC —á–µ—Ä–µ–∑ {{ days_fomc }} –¥–Ω–µ–π
                {% endif %}
                {{ next_macro }}
              data:
                group: "crypto-weekly"
                tag: "weekly-summary"
                importance: default

      # English (default)
      - conditions:
          - condition: template
            value_template: "{{ lang == 'en' }}"
        sequence:
          - service: !input notify_service
            data:
              title: "üìä Weekly Crypto Summary"
              message: >-
                üìà PORTFOLIO
                Value: ${{ '{:,.0f}'.format(portfolio_value) }}
                Weekly P&L: {{ '+' if pnl_7d > 0 else '' }}{{ pnl_7d | round(1) }}%
                Goal Progress: {{ goal_progress | round(0) }}%

                üå°Ô∏è MARKET
                Fear & Greed: {{ fear_greed }}
                Phase: {{ investor_phase }}
                BTC.D: {{ btc_dominance | round(1) }}%
                Altseason: {{ altseason }}

                üéØ RECOMMENDATIONS
                DCA: {{ dca_signal }}
                {{ weekly_insight }}

                ‚ö†Ô∏è RISK
                Sharpe: {{ sharpe }}
                Max DD: {{ max_dd }}%

                üìÖ NEXT WEEK
                Macro Risk: {{ macro_risk }}
                {% if days_fomc and days_fomc | int < 14 %}
                FOMC in {{ days_fomc }} days
                {% endif %}
                {{ next_macro }}
              data:
                group: "crypto-weekly"
                tag: "weekly-summary"
                importance: default

mode: single
