# =============================================================================
# Goal Milestone Blueprint
# =============================================================================
# Celebrates goal milestones at 10%, 25%, 50%, 75%, 90%, and 100%
#
# Usage: Import into Home Assistant blueprints and configure notification service
# =============================================================================

blueprint:
  name: "Crypto Goal Milestone / Ğ­Ñ‚Ğ°Ğ¿ Ñ†ĞµĞ»Ğ¸"
  description: >-
    Celebrate portfolio goal milestones with notifications.
    ĞÑ‚Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ğ¿Ğ¾Ğ² Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ¾Ğ¹ Ñ†ĞµĞ»Ğ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸ÑĞ¼Ğ¸.
  domain: automation
  author: "Crypto Inspect Add-on"
  source_url: "https://github.com/Mesteriis/crypto-inspector"

  input:
    notify_device:
      name: "Notification Service / Ğ¡ĞµÑ€Ğ²Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹"
      description: >-
        The notification service to use.
        Ğ¡ĞµÑ€Ğ²Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸.
      selector:
        text:
      default: "notify.mobile_app"

    language:
      name: "Language / Ğ¯Ğ·Ñ‹Ğº"
      description: >-
        Notification language.
        Ğ¯Ğ·Ñ‹Ğº ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹.
      selector:
        select:
          options:
            - label: "English"
              value: "en"
            - label: "Ğ ÑƒÑÑĞºĞ¸Ğ¹"
              value: "ru"
      default: "ru"

    milestone_10:
      name: "Notify at 10% / Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ğ½Ğ° 10%"
      selector:
        boolean:
      default: true

    milestone_25:
      name: "Notify at 25% / Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ğ½Ğ° 25%"
      selector:
        boolean:
      default: true

    milestone_50:
      name: "Notify at 50% / Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ğ½Ğ° 50%"
      selector:
        boolean:
      default: true

    milestone_75:
      name: "Notify at 75% / Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ğ½Ğ° 75%"
      selector:
        boolean:
      default: true

    milestone_90:
      name: "Notify at 90% / Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ğ½Ğ° 90%"
      selector:
        boolean:
      default: true

    milestone_100:
      name: "Notify at 100% / Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ğ½Ğ° 100%"
      selector:
        boolean:
      default: true

trigger:
  - platform: numeric_state
    entity_id: sensor.crypto_inspect_goal_progress
    above: 10
    id: "milestone_10"
  - platform: numeric_state
    entity_id: sensor.crypto_inspect_goal_progress
    above: 25
    id: "milestone_25"
  - platform: numeric_state
    entity_id: sensor.crypto_inspect_goal_progress
    above: 50
    id: "milestone_50"
  - platform: numeric_state
    entity_id: sensor.crypto_inspect_goal_progress
    above: 75
    id: "milestone_75"
  - platform: numeric_state
    entity_id: sensor.crypto_inspect_goal_progress
    above: 90
    id: "milestone_90"
  - platform: numeric_state
    entity_id: sensor.crypto_inspect_goal_progress
    above: 100
    id: "milestone_100"

condition:
  - condition: or
    conditions:
      - condition: and
        conditions:
          - condition: trigger
            id: "milestone_10"
          - condition: template
            value_template: "{{ milestone_10 | default(true) }}"
      - condition: and
        conditions:
          - condition: trigger
            id: "milestone_25"
          - condition: template
            value_template: "{{ milestone_25 | default(true) }}"
      - condition: and
        conditions:
          - condition: trigger
            id: "milestone_50"
          - condition: template
            value_template: "{{ milestone_50 | default(true) }}"
      - condition: and
        conditions:
          - condition: trigger
            id: "milestone_75"
          - condition: template
            value_template: "{{ milestone_75 | default(true) }}"
      - condition: and
        conditions:
          - condition: trigger
            id: "milestone_90"
          - condition: template
            value_template: "{{ milestone_90 | default(true) }}"
      - condition: and
        conditions:
          - condition: trigger
            id: "milestone_100"
          - condition: template
            value_template: "{{ milestone_100 | default(true) }}"

action:
  - variables:
      lang: !input language
      progress: "{{ states('sensor.crypto_inspect_goal_progress') | float(0) | round(1) }}"
      goal_name: "{{ state_attr('sensor.crypto_inspect_goal_target', 'goal_name') }}"
      goal_name_ru: "{{ state_attr('sensor.crypto_inspect_goal_target', 'goal_name_ru') }}"
      current: "{{ state_attr('sensor.crypto_inspect_goal_progress', 'current') | float(0) }}"
      target: "{{ state_attr('sensor.crypto_inspect_goal_progress', 'target') | float(0) }}"
      remaining: "{{ state_attr('sensor.crypto_inspect_goal_progress', 'remaining') | float(0) }}"
      milestone: "{{ trigger.id | replace('milestone_', '') }}"

  - variables:
      emoji_map:
        "10": "ğŸŒ±"
        "25": "ğŸ“ˆ"
        "50": "ğŸš€"
        "75": "ğŸŒŸ"
        "90": "ğŸ”¥"
        "100": "ğŸ†"
      emoji: "{{ emoji_map[milestone] | default('ğŸ¯') }}"

  - choose:
      # Russian
      - conditions:
          - condition: template
            value_template: "{{ lang == 'ru' }}"
        sequence:
          - service: !input notify_device
            data:
              title: "{{ emoji }} Ğ­Ñ‚Ğ°Ğ¿ Ñ†ĞµĞ»Ğ¸: {{ milestone }}%!"
              message: >-
                {% if milestone == '100' %}
                ğŸ‰ ĞŸĞ¾Ğ·Ğ´Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼! Ğ’Ñ‹ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³Ğ»Ğ¸ Ñ†ĞµĞ»Ğ¸ "{{ goal_name_ru }}"!

                Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°: ${{ current | round(2) }}

                Ğ­Ñ‚Ğ¾ Ğ¿Ğ¾Ñ‚Ñ€ÑÑĞ°ÑÑ‰ĞµĞµ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ! ğŸ†
                {% else %}
                Ğ’Ñ‹ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³Ğ»Ğ¸ {{ milestone }}% Ñ†ĞµĞ»Ğ¸ "{{ goal_name_ru }}"!

                Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ: ${{ current | round(2) }}
                Ğ¦ĞµĞ»ÑŒ: ${{ target | round(2) }}
                ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ: ${{ remaining | round(2) }}

                ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ğ¹Ñ‚Ğµ Ğ² Ñ‚Ğ¾Ğ¼ Ğ¶Ğµ Ğ´ÑƒÑ…Ğµ! ğŸ’ª
                {% endif %}
              data:
                group: "crypto-goals"
                tag: "goal-milestone-{{ milestone }}"
                importance: high

      # English (default)
      - conditions:
          - condition: template
            value_template: "{{ lang == 'en' }}"
        sequence:
          - service: !input notify_device
            data:
              title: "{{ emoji }} Goal Milestone: {{ milestone }}%!"
              message: >-
                {% if milestone == '100' %}
                ğŸ‰ Congratulations! You've achieved your "{{ goal_name }}" goal!

                Final amount: ${{ current | round(2) }}

                This is an amazing achievement! ğŸ†
                {% else %}
                You've reached {{ milestone }}% of your "{{ goal_name }}" goal!

                Current: ${{ current | round(2) }}
                Target: ${{ target | round(2) }}
                Remaining: ${{ remaining | round(2) }}

                Keep up the great work! ğŸ’ª
                {% endif %}
              data:
                group: "crypto-goals"
                tag: "goal-milestone-{{ milestone }}"
                importance: high

mode: single
