name: CI/CD

on:
  push:
    branches: [main, master]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.github/*.md'
      - 'LICENSE'
  pull_request:
    branches: [main, master]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.github/*.md'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force release even without version change'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.13"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  COVERAGE_THRESHOLD: 60

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #                     CHANGE DETECTION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      src: ${{ steps.filter.outputs.src }}
      tests: ${{ steps.filter.outputs.tests }}
      docker: ${{ steps.filter.outputs.docker }}
      deps: ${{ steps.filter.outputs.deps }}
      addon: ${{ steps.filter.outputs.addon }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Filter paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            src:
              - 'src/**'
            tests:
              - 'tests/**'
            docker:
              - 'Dockerfile'
              - 'rootfs/**'
            deps:
              - 'requirements.txt'
              - 'pyproject.toml'
            addon:
              - 'config.yaml'
              - 'config.json'
              - 'Dockerfile'
              - 'rootfs/**'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #                     PYTHON TESTING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  lint:
    name: ðŸ” Python Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.src == 'true' || needs.changes.outputs.tests == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Ruff
        run: pip install ruff

      - name: Run Ruff linter
        run: ruff check src/ tests/ --output-format=github

      - name: Run Ruff formatter check
        run: ruff format src/ tests/ --check

  test:
    name: ðŸ§ª Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: [changes, lint]
    if: always() && (needs.lint.result == 'success' || needs.lint.result == 'skipped')
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12", "3.13"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx

      - name: Run tests with coverage
        env:
          PYTHONPATH: src
        run: |
          pytest tests/ -v --tb=short \
            --cov=src \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=${{ env.COVERAGE_THRESHOLD }}

      - name: Upload coverage
        if: matrix.python-version == '3.13'
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          file: ./coverage.xml

  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.src == 'true' || needs.changes.outputs.deps == 'true'
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          severity: CRITICAL,HIGH
          exit-code: 0

      - name: Run pip-audit
        run: |
          pip install pip-audit
          pip-audit -r requirements.txt || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #                HOME ASSISTANT ADD-ON TESTING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  addon-info:
    name: ðŸ“‹ Add-on Info
    runs-on: ubuntu-latest
    outputs:
      architectures: ${{ steps.info.outputs.architectures }}
      build: ${{ steps.info.outputs.build }}
      description: ${{ steps.info.outputs.description }}
      name: ${{ steps.info.outputs.name }}
      slug: ${{ steps.info.outputs.slug }}
      target: ${{ steps.info.outputs.target }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get add-on information
        id: info
        uses: frenck/action-addon-information@v1.4.2

  addon-lint:
    name: ðŸ  Add-on Lint
    runs-on: ubuntu-latest
    needs: [addon-info]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Add-on Lint
        uses: frenck/action-addon-linter@v2.16
        with:
          path: "./${{ needs.addon-info.outputs.target }}"

  hadolint:
    name: ðŸ‹ Dockerfile Lint
    runs-on: ubuntu-latest
    needs: [changes, addon-info]
    if: needs.changes.outputs.docker == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: "./${{ needs.addon-info.outputs.target }}/Dockerfile"
          ignore: DL3002,DL3006,DL3007,DL3008,DL3018

  shellcheck:
    name: ðŸš Shellcheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Shellcheck
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: './rootfs'
        env:
          SHELLCHECK_OPTS: -s bash
        continue-on-error: true

  yamllint:
    name: ðŸ“ YAMLLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run YAMLLint
        uses: frenck/action-yamllint@v1.5
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #           HOME ASSISTANT BUILD TEST (Multi-arch)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  addon-build:
    name: ðŸ—ï¸ HA Build (${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: [addon-info, addon-lint, hadolint, lint, test]
    if: always() && !contains(needs.*.result, 'failure')
    strategy:
      fail-fast: false
      matrix:
        arch: ["amd64", "aarch64"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get build info
        id: build-info
        run: |
          if [ -f "build.yaml" ]; then
            FROM=$(yq eval ".build_from.${{ matrix.arch }}" build.yaml)
          elif [ -f "build.json" ]; then
            FROM=$(jq -r ".build_from.${{ matrix.arch }}" build.json)
          else
            # Default HA base images
            if [ "${{ matrix.arch }}" = "amd64" ]; then
              FROM="ghcr.io/home-assistant/amd64-base-python:3.13-alpine3.21"
            else
              FROM="ghcr.io/home-assistant/aarch64-base-python:3.13-alpine3.21"
            fi
          fi
          echo "from=$FROM" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ Base image: $FROM"

      - name: Test build with HA Builder
        uses: home-assistant/builder@2025.01.0
        with:
          args: |
            --test \
            --${{ matrix.arch }} \
            --target ${{ needs.addon-info.outputs.target }} \
            --docker-hub ghcr.io/${{ github.repository_owner }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #                    AUTO-RELEASE ON VERSION CHANGE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  check-version:
    name: ðŸ”„ Check Version
    runs-on: ubuntu-latest
    needs: [addon-build]
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    outputs:
      version: ${{ steps.version.outputs.current }}
      version_changed: ${{ steps.version.outputs.changed }}
      should_release: ${{ steps.version.outputs.should_release }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version
        id: version
        run: |
          # Try pyproject.toml first, then config.yaml/json
          if [ -f "pyproject.toml" ]; then
            CURRENT=$(grep -m1 'version = ' pyproject.toml | sed 's/.*version = "\([^"]*\)".*/\1/')
          elif [ -f "config.yaml" ]; then
            CURRENT=$(yq eval '.version' config.yaml)
          elif [ -f "config.json" ]; then
            CURRENT=$(jq -r '.version' config.json)
          else
            echo "::error::No version file found"
            exit 1
          fi

          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ Current version: $CURRENT"

          if git rev-parse "v$CURRENT" >/dev/null 2>&1; then
            echo "ðŸ·ï¸ Tag v$CURRENT exists - skipping release"
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "should_release=false" >> "$GITHUB_OUTPUT"
          else
            echo "âœ¨ New version: $CURRENT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "should_release=true" >> "$GITHUB_OUTPUT"
          fi

  create-release:
    name: ðŸ“¦ Create Release
    runs-on: ubuntu-latest
    needs: [check-version]
    if: needs.check-version.outputs.should_release == 'true' || inputs.force_release == true
    permissions:
      contents: write
    outputs:
      version: ${{ needs.check-version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create tag
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          {
            echo "changelog<<EOF"
            echo "## What's Changed"
            echo ""
            if [ -n "$PREV_TAG" ]; then
              git log --pretty=format:"- %s (%h)" "$PREV_TAG"..HEAD~1
            else
              git log --pretty=format:"- %s (%h)" -15
            fi
            echo ""
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: v${{ needs.check-version.outputs.version }}
          body: |
            ${{ steps.changelog.outputs.changelog }}

            ---
            **Docker images** available at:
            ```
            ghcr.io/${{ github.repository }}/amd64:${{ needs.check-version.outputs.version }}
            ghcr.io/${{ github.repository }}/aarch64:${{ needs.check-version.outputs.version }}
            ```
          draft: false
          prerelease: false
          generate_release_notes: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #                    BUILD & PUSH DOCKER
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  release:
    name: ðŸš€ Publish ${{ matrix.arch }}
    runs-on: ubuntu-latest
    needs: [create-release, addon-info]
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        arch: ["amd64", "aarch64"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and publish with HA Builder
        uses: home-assistant/builder@2025.01.0
        with:
          args: |
            --${{ matrix.arch }} \
            --target ${{ needs.addon-info.outputs.target }} \
            --docker-hub ghcr.io/${{ github.repository_owner }} \
            --addon

  update-release:
    name: ðŸ“ Update Release
    runs-on: ubuntu-latest
    needs: [create-release, release]
    permissions:
      contents: write
    steps:
      - name: Update release notes
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          append_body: true
          body: |

            ---
            ### Docker Images Ready âœ…
            ```bash
            docker pull ghcr.io/${{ github.repository }}/amd64:${{ needs.create-release.outputs.version }}
            docker pull ghcr.io/${{ github.repository }}/aarch64:${{ needs.create-release.outputs.version }}
            ```

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #                         CI STATUS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ci-status:
    name: âœ… CI Status
    runs-on: ubuntu-latest
    needs: [lint, test, addon-lint, hadolint, addon-build]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Python" >> $GITHUB_STEP_SUMMARY
          [[ "${{ needs.lint.result }}" == "success" ]] && echo "âœ… Lint" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          [[ "${{ needs.test.result }}" == "success" ]] && echo "âœ… Tests" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Home Assistant Add-on" >> $GITHUB_STEP_SUMMARY
          [[ "${{ needs.addon-lint.result }}" == "success" ]] && echo "âœ… Add-on Lint" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ Add-on Lint: ${{ needs.addon-lint.result }}" >> $GITHUB_STEP_SUMMARY
          [[ "${{ needs.hadolint.result }}" == "success" ]] && echo "âœ… Dockerfile" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ Dockerfile: ${{ needs.hadolint.result }}" >> $GITHUB_STEP_SUMMARY
          [[ "${{ needs.addon-build.result }}" == "success" ]] && echo "âœ… HA Build Test" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ HA Build: ${{ needs.addon-build.result }}" >> $GITHUB_STEP_SUMMARY

          # Fail if critical jobs failed
          if [[ "${{ needs.test.result }}" == "failure" ]] || \
             [[ "${{ needs.addon-build.result }}" == "failure" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **CI Failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **All CI Checks Passed!**" >> $GITHUB_STEP_SUMMARY
